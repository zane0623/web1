"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["ui_packages_copilot-chat_utils_CopilotChatContext_tsx"],{22756:(e,t,s)=>{s.d(t,{L:()=>BlackbirdPermissionCaches});var a=s(56176),i=s(57572);function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let BlackbirdPermissionCaches=class BlackbirdPermissionCaches{async setupWarmCachesLoop(){(0,a.M3)()&&(BlackbirdPermissionCaches.warmCachesLoopSetup?await BlackbirdPermissionCaches.warm:(BlackbirdPermissionCaches.warmCachesLoopSetup=!0,await this.warmCaches()))}async warmCaches(){let e=54e4;try{let t=await (0,i.lS)("/search/warm_blackbird_caches",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}),s=await t.json();e=new Date(s.userCacheExpiresAt).getTime()-Date.now()-3e4,(isNaN(e)||e<=5)&&(e=3e4)}catch{}BlackbirdPermissionCaches.warmResolve(),setTimeout(()=>{this.warmCaches()},e)}};r(BlackbirdPermissionCaches,"warmCachesLoopSetup",!1),r(BlackbirdPermissionCaches,"warmResolve",void 0),r(BlackbirdPermissionCaches,"warm",new Promise(e=>{BlackbirdPermissionCaches.warmResolve=e}))},56244:(e,t,s)=>{function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{d:()=>ApiCache});let ApiCache=class ApiCache{async get(...e){let t=e.join(this.separator),s=this.cache.get(t);if(s)return s;{let s=this.fetchFn(...e);return this.cache.set(t,s),(await s).ok||this.cache.delete(t),s}}constructor(e){a(this,"separator","-!-"),a(this,"cache",new Map),this.fetchFn=e}}},96558:(e,t,s)=>{s.d(t,{Bc:()=>r,Qs:()=>c,fv:()=>n,uN:()=>i,wJ:()=>l,wX:()=>o,wg:()=>a});let a="copilot-chat-textarea",i="copilot-chat-topic-search",r="Review",n="copilot-chat-header-button",o="copilot-diff-header-button",l="copilot-chat-panel",c="copilot-chat-panel"},55854:(e,t,s)=>{function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{X:()=>CopilotChatMessageStreamer});let i=/^data:\s+/;let CopilotStreamingError=class CopilotStreamingError extends Error{constructor(e){super(e.description),a(this,"error",void 0),this.error=e,this.name="CopilotStreamingError"}};let CopilotChatMessageStreamer=class CopilotChatMessageStreamer{async *stream(){let e=new TextDecoder("utf-8"),t="";for(;;){let s,a;try{({value:s,done:a}=await this.reader.read())}catch{throw new CopilotStreamingError({type:"error",errorType:"networkError",description:"NETWORK_CONNECTION_INTERRUPTED"})}if(a)break;for(t+=e.decode(s);;){let e=t.indexOf("\n\n");if(-1===e)break;let s=t.slice(0,e).replace(i,"");if("[DONE]"===s)return;let a=JSON.parse(s);if(yield a,a?.type==="complete")return;t=t.slice(e+2)}}}async stop(){return this.reader.cancel()}constructor(e){a(this,"reader",void 0),this.reader=e}}},37404:(e,t,s)=>{s.d(t,{k:()=>CopilotChatService});var a=s(22756),i=s(49339),r=s(5796),n=s(57572),o=s(56244),l=s(82610),c=s(37937),d=s(48247);function h(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let u=new Set(["snippet","file","symbol","docset","repository"]);let CopilotChatService=class CopilotChatService{async fetchThreads(e={}){let t=new URLSearchParams;"string"==typeof e.name&&t.set("name",e.name);let s=`/threads?${t.toString()}`,a=await this.makeCAPIRequest(s,"GET");if(!a.ok)return a;let i=(await a.json()).threads||[];return{status:a.status,ok:!0,payload:i}}async fetchLatestThread(e){let t=new URLSearchParams;"string"==typeof e&&t.set("thread_id",e);let s=await this.makeCAPIRequest(`/threads/latest?${t.toString()}`,"GET");if(!s.ok)return s;let a=(await s.json()).thread;return{status:s.status,ok:!0,payload:a}}async createThread(e){let t=await this.makeCAPIRequest("/threads","POST",{custom_copilot_id:e});if(!t.ok)return t;let s=(await t.json()).thread;return{status:t.status,ok:!0,payload:s}}async deleteThread(e){let t=await this.makeCAPIRequest(`/threads/${e}`,"DELETE");return t.ok?{status:t.status,ok:!0,payload:null}:t}async deleteCopilotSpace(e){let t=await (0,n.lS)(`/custom_copilots/${e}`,{method:"DELETE"});return t.ok?{status:t.status,ok:!0,payload:null}:t}async deleteAllThreads(e){let t=await this.makeCAPIRequest("/threads","DELETE",e);return t.ok?{status:t.status,ok:!0,payload:null}:t}async renameThread(e,t){let s=await this.makeCAPIRequest(`/threads/${e}/name`,"PATCH",{generate:!1,name:t});if(!s.ok)return s;let a=(await s.json()).name||"";return{status:s.status,ok:!0,payload:a}}async clearThread(e){let t=await this.makeCAPIRequest(`/threads/${e}/clear`,"PATCH");return t.ok?{status:t.status,ok:!0,payload:null}:t}async shareThread(e,t){let s=await this.makeCAPIRequest(`/threads/${e}/share`,"PATCH",{shared_message_id:t});if(!s.ok)return s;let a=(await s.json()).thread;return{status:s.status,ok:!0,payload:a}}async unshareThread(e){let t=await this.makeCAPIRequest(`/threads/${e}/unshare`,"PATCH");if(!t.ok)return t;let s=(await t.json()).thread;return{status:t.status,ok:!0,payload:s}}async continueSharedThread(e){let t=await this.makeCAPIRequest(`/shared/${e}/duplicate`,"POST");return t.ok?{status:200,ok:!0,payload:await t.json()}:t}async generateThreadName(e){let t=await this.makeCAPIRequest(`/threads/${e}/name`,"PATCH",{generate:!0,name:""});if(!t.ok)return t;let s=(await t.json()).name||"";return{status:t.status,ok:!0,payload:s}}async getSystemPrompt(e){let t=await this.makeCAPIRequest(`/system_prompt/${e}`,"GET");if(!t.ok)return t;let s=await t.json();return{status:t.status,ok:!0,payload:s}}async listMessages(e){if(this.listMessagesCache?.thread.id===e)return{status:200,ok:!0,payload:this.listMessagesCache};let t=await this.makeCAPIRequest(`/threads/${e}/messages`,"GET");if(!t.ok){if(!(404===t.status&&t.response?.headers.has("Content-Type"))||"application/json"!==t.response.headers.get("Content-Type"))return t;{let e=await t.response.json();return{...t,payload:e}}}let s=await t.json();return this.listMessagesCache=s,{status:t.status,ok:!0,payload:s}}async listSharedThreadMessages(e){let t=await this.makeCAPIRequest(`/shared/${e}/messages`,"GET");if(!t.ok)return t;let s=await t.json();return{status:t.status,ok:!0,payload:s}}async createMessage(e,t,s,a,i,r,n){this.listMessagesCache=void 0;let o=await this.makeCAPIRequest(`/threads/${e}/messages`,"POST",{content:t,mediaContent:s,intent:a,references:i,currentURL:window.location.href,customInstructions:r,model:n,settings:c.J.settings??void 0});if(!o.ok)return o;let l=(await o.json()).message;return{status:o.status,ok:!0,payload:l}}async createMessageStreaming({threadID:e,messageID:t,content:s,mediaContent:a,intent:i,mode:r,references:n,context:o,confirmations:l,customInstructions:d,model:h,customCopilotID:u,parentMessageID:p,tools:m,clientToolResults:g,signal:f}){this.listMessagesCache=void 0;let E={responseMessageID:t,content:s,intent:i,references:n,context:o,currentURL:window.location.href,streaming:!0,confirmations:l,customInstructions:d,model:h,mode:r,settings:c.J.settings??void 0,customCopilotID:u,parentMessageID:p,tools:m,clientToolResults:g,mediaContent:a},y=this.processQueryParams(new URLSearchParams(window.location.search)),C=await this.makeCAPIRequest(`/threads/${e}/messages?${y.toString()}`,"POST",E,!0,void 0,f);return C.ok?{status:C.status,ok:!0,response:C}:C}processQueryParams(e){let t=["instruction_prompt"],s=new URLSearchParams;for(let[a,i]of e)t.includes(a)&&s.append(a,i);return s}async listModels(){let e=await this.makeCAPIRequest("/models","GET",void 0,!1,"");if(!e.ok)return e;let t=await e.json();return{status:e.status,ok:!0,payload:t.data}}async setModelPolicyState(e,t){let s=await this.makeCAPIRequest(`/models/${e}/policy`,"POST",{state:t},!1,"");if(!s.ok)return Promise.reject(Error(`Failed to update model policy state: ${s.status}`))}async sendFeedback({feedback:e,feedbackChoice:t,messageId:s,threadId:a,textResponse:i}){let r=await this.makeDotcomRequest(`${this.urlPathPrefix}/feedback`,"POST",{feedback:e,feedback_choice:t,message_id:s,thread_id:a,text_response:i});return r.ok?{status:r.status,ok:!0,payload:null}:r}async listDocsets(){let e=await this.fetchDocsetsResponse();return e.ok?{status:200,ok:!0,payload:e.payload.knowledgeBases}:e}async listAdministratedCopilotEnterpriseOrganizations(){let e=await this.fetchDocsetsResponse();return e.ok?{status:200,ok:!0,payload:e.payload.administratedCopilotEnterpriseOrganizations}:e}fetchDocsetsResponse(){return this.docsetsPromise||(this.docsetsPromise=this.docsetRequestPromise()),this.docsetsPromise}async docsetRequestPromise(){let e=await this.makeDotcomRequest("/github-copilot/docs/docsets","GET");return e.ok?{status:200,ok:!0,payload:await e.json()}:e}async deleteDocset(e){let t=await this.makeDotcomRequest(`/copilot/docsets/${e.id}`,"DELETE");return t.ok?{status:t.status,ok:!0,payload:null}:t}async listRepoFiles(e,t=!1){let s=(0,r.ClY)({repo:e,commitOid:e.commitOID,includeDirectories:t});return this.repoFilesCache.get(s)}async querySymbols(e,t){return await this.blackbirdCaches.setupWarmCachesLoop(),this.querySymbolsCache.get(e.ownerLogin,e.name,t)}async fetchImplicitContext(e,t,s){let a=await this.makeDotcomRequest(`${this.urlPathPrefix}/implicit-context/${t}/${s}/${encodeURIComponent(e)}`,"GET");return a.ok?{status:a.status,ok:a.ok,payload:await a.json()}:a}async fetchRepo(e){let t;if(this.repoDetailsCache.has(e))t=this.repoDetailsCache.get(e);else{let s=await this.makeDotcomRequest(`${this.urlPathPrefix}/repositories/${e}`,"GET");if(!s.ok)return s;t=await s.json(),this.repoDetailsCache.set(e,t)}return{status:200,ok:!0,payload:t}}async listAgents(e){let t=await (0,n.lS)(e);if(!t.ok)return{status:t.status,ok:!1,error:l.Sr[t.status]||l.DW};let s=await t.json();return{status:t.status,ok:t.ok,payload:s}}async listCustomCopilots(){let e=await (0,n.lS)(`${this.urlPathPrefix}/custom_copilots`);if(!e.ok)return{status:e.status,ok:!1,error:l.Sr[e.status]||l.DW};let t=await e.json();return{status:e.status,ok:!0,payload:t}}async fetchCustomCopilot(e){let t=await (0,n.lS)(`${this.urlPathPrefix}/custom_copilots/${e}`);if(!t.ok)return{status:t.status,ok:!1,error:l.Sr[t.status]||l.DW};let s=await t.json();return{status:t.status,ok:!0,payload:s}}async hydrateReference(e){if(!u.has(e.type))return{status:204,ok:!0,payload:e};let t=await this.makeDotcomRequest(`${this.urlPathPrefix}/reference_details`,"POST",{reference:e});return t.ok?{status:t.status,ok:t.ok,payload:await t.json()}:t}async fetchLanguageForFileReference(e){let{repoOwner:t,repoName:s}=e,a=window.btoa(e.path),i=(0,r.RT3)({ownerLogin:t,name:s},a,!0),n=await this.makeDotcomRequest(i,"GET");return n.ok?{status:n.status,ok:n.ok,payload:await n.json()}:n}async makeDotcomRequest(e,t,s){let a={};for(let e of(0,d.f)()){let t=e.split("="),s=t[0]?.replaceAll("_","-"),i="1";t.length>1&&(i=t[1]),a[`X-Experiment-${s}`]=i}let i=await this.copilotAuthTokenProvider.getAuthToken();a["X-Copilot-Api-Token"]=i.value;try{let i=await (0,n.lS)(e,{method:t,body:s,headers:a});if(i.ok)return i;return{status:i.status,ok:!1,error:l.Sr[i.status]||l.DW}}catch{return{status:500,ok:!1,error:l.DW}}}get directConnectConfiguration(){return{integrationID:"copilot-chat"}}async makeCAPIRequest(e,t,s,a=!1,i="/github/chat",r){let n=this.apiURL,o=await this.copilotAuthTokenProvider.getAuthToken();return await (0,l.p)({basePath:n+i,path:e,method:t,body:s,streamingResponse:a,authToken:o,integrationId:this.directConnectConfiguration.integrationID,realIp:this.realIp,signal:r})}constructor(e,t,s){h(this,"apiURL",void 0),h(this,"urlPathPrefix","/github-copilot/chat"),h(this,"docsetsPromise",void 0),h(this,"repoDetailsCache",new Map),h(this,"listMessagesCache",void 0),h(this,"copilotAuthTokenProvider",void 0),h(this,"blackbirdCaches",new a.L),h(this,"realIp",void 0),h(this,"listRepoFilesImpl",async e=>{let t=await this.makeDotcomRequest(e,"GET");return t.ok?{status:200,ok:!0,payload:await t.json()}:t}),h(this,"repoFilesCache",new o.d(this.listRepoFilesImpl)),h(this,"querySymbolsImpl",async(e,t,s)=>{let a=await this.makeDotcomRequest(`/search/suggestions?query=repo:${e}/${t} ${s}`,"GET");return a.ok?{status:200,ok:!0,payload:(await a.json()).suggestions.filter(e=>"SUGGESTION_KIND_SYMBOL"===e.kind)}:a}),h(this,"querySymbolsCache",new o.d(this.querySymbolsImpl)),this.apiURL=e,this.copilotAuthTokenProvider=new i.J(t.map(e=>e.id)),this.realIp=s||""}}},93589:(e,t,s)=>{s.d(t,{B:()=>r,CX:()=>c,HR:()=>l,TC:()=>o,ws:()=>n,zh:()=>i});var a=s(46988);function i(e,t=!0){let s=performance.now(),r=0,n=e.map(e=>({...e})),o={id:"root",role:"user",createdAt:"",threadID:"",references:null,childMessageIndexes:[],messageIndex:0,clientSide:!1};if(0===n.length)return n.push(o),r=performance.now()-s,(0,a.BI)("copilot.timings",{function:"constructMessagesHierarchy",timeElapsed:r,messagesLength:n.length,selectMostRecentMessages:t}),n;"root"!==n[0].id&&(n.unshift(o),(0,a.BI)("copilot.legacy_thread_updated",{threadID:n[1].threadID,messagesLength:n.length,selectMostRecentMessages:t}));let l=n[1];l.parentMessageID="root";let d=new Map;for(let[e,t]of n.entries()){if(t.messageIndex=e,t.childMessageIndexes=[],d.set(t.id,e),"root"===t.id)continue;t.parentMessageID||(t.parentMessageID=l.id,l=t);let s=d.get(t.parentMessageID);if(void 0!==s){t.parentMessageIndex=s;let e=n[s];e&&(e.childMessageIndexes.push(t.messageIndex),void 0===e.selectedChildIndex&&(e.selectedChildIndex=t.messageIndex))}}if(t){let e=n.at(-1);for(;e;){let t=c(n,e);t&&(t.selectedChildIndex=e.messageIndex),e=t}}return r=performance.now()-s,(0,a.BI)("copilot.timings",{function:"constructMessagesHierarchy",timeElapsed:r,messagesLength:n.length,selectMostRecentMessages:t}),n}function r(e){let t=e[0],s=[];for(;t;)"root"!==t.id&&s.push(t),t=void 0!==t.selectedChildIndex?e[t.selectedChildIndex]:void 0;return s}function n(e,t){let s=e.map(e=>({...e})),a=s[t.parentMessageIndex];return a&&(a.selectedChildIndex=t.messageIndex),s}function o(e,t){let s=e.map(e=>({...e})),a=s[t.messageIndex];return a&&void 0!==a.selectedChildIndex&&(a.selectedChildIndex=void 0),s}function l(e,t){let s=e.map(e=>({...e})),a={...t},i=s.find(e=>e.id===a?.parentMessageID);return i&&(s.push(a),a.messageIndex=e.length,a.childMessageIndexes=[],a.parentMessageIndex=i.messageIndex,i.childMessageIndexes||(i.childMessageIndexes=[]),i.childMessageIndexes.includes(a.messageIndex)||i.childMessageIndexes.push(a.messageIndex),i.selectedChildIndex=a.messageIndex),s}function c(e,t){return void 0!==t.parentMessageIndex?e[t.parentMessageIndex]:void 0}},27297:(e,t,s)=>{s.d(t,{UB:()=>n,eW:()=>o});var a=s(2622);let i="/images/modules/marketplace/models/families/openai.svg",r=new Map([["Azure OpenAI",i],["Anthropic","/images/modules/marketplace/models/families/anthropic.svg"],["Google","/images/modules/marketplace/models/families/gemini.svg"]]),n={capabilities:{family:"gpt-4o",limits:{max_prompt_tokens:2e4,vision:{supported_media_types:["image/jpeg","image/png","image/webp","image/gif"]}},supports:{parallel_tool_calls:!0,tool_calls:!0},tokenizer:"o200k_base",type:"chat"},id:"gpt-4o",name:"GPT 4o",version:"gpt-4o-2024-05-13",displayName:"GPT 4o",vendor:"Azure OpenAI",logoURL:i,hasLimitedCapabilities:!1,preview:!1,isThirdParty:!1,model_picker_enabled:!0};function o(e){return(e??[n]).map(l).filter(e=>!!e).filter(e=>e.model_picker_enabled)}function l(e){var t;return"chat"===e.capabilities.type&&e.model_picker_enabled&&(!e.policy||"enabled"===e.policy.state||e.policy.terms)?{...e,displayName:function(e){for(let t of c)if(e.name.endsWith(t))return e.name.replace(t,"").trim();return e.name}(e),hasLimitedCapabilities:(t=a.W.copilotChatO1Tools,"o1-ga"===e.capabilities.family?!t:!e.capabilities.supports.tool_calls),isThirdParty:"Azure OpenAI"!==e.vendor,logoURL:r.get(e.vendor)}:null}let c=["(Beta)","(Preview)"]},84310:(e,t,s)=>{s.d(t,{K:()=>ReadLocalWorkspaceFileSkill});var a=s(80688),i=s(59937),r=s(90254);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let ReadLocalWorkspaceFileSkill=class ReadLocalWorkspaceFileSkill{requiresConfirmation(){return!1}confirmationMessage(){return"Read the local workspace file"}static schema(){return{type:"function",function:{name:"read-local-workspace-file",description:"Read a local file. This can be used to read files on the user's local machine. It is the equivalent of running `cat` in the terminal. The file path is relative to the current directory.",parameters:{type:"object",required:["path","repository","pullRequest"],properties:{path:{type:"string",description:"The path to the file to read."},repository:{required:["ownerLogin","name"],type:"object",description:"the repository containing the file to read.",properties:{ownerLogin:{type:"string",description:"the owner of the repository."},name:{type:"string",description:"the name of the repository."}}},pullRequest:{type:"object",description:"the pull request containing the file to read.",required:["number","headSHA"],properties:{number:{type:"string",description:"the number of the pull request."},headSHA:{type:"string",description:"the head SHA of the pull request."}}}}}}}}assertDefined(e,t){if(null==e)throw Error(t)}validateArgs(){let e=JSON.parse(this.rawArguments);return this.assertDefined(e,"No parsed arguments found in raw arguments"),this.assertDefined(e.path,"No path found on parsed arguments"),this.assertDefined(e.repository,"No repository found on parsed arguments"),this.assertDefined(e.pullRequest,"No pullRequest found on parsed arguments"),this.assertDefined(e.repository.ownerLogin,"No ownerLogin found on repository"),this.assertDefined(e.repository.name,"No name found on repository"),this.assertDefined(e.pullRequest.number,"No number found on pullRequest"),this.assertDefined(e.pullRequest.headSHA,"No headSHA found on pullRequest"),e}getArguments(){let e=this.validateArgs(),{repository:t,pullRequest:s}=e;return{path:e.path.startsWith("./")?e.path.slice(2):e.path,repository:t,pullRequest:s}}async fetchBlob(e,t,s){try{let a=await this.blobService.getBlob(e,t.ownerLogin,s.number,t.name,s.headSHA);return a.ok&&a.payload.blobContents||""}catch{return""}}toResult(e,t){return{ok:t,result:e}}async execute(){try{let e=(0,a.A)("localStorage"),{path:t,repository:s,pullRequest:i}=this.getArguments(),n=await this.fetchBlob(t,s,i),o=`hadron-editor-file-deltas-v2/${s.ownerLogin}/${s.name}/${i.number}`,l=JSON.parse(e.getItem(o)||"{}"),c=(l||{diffs:[],sessionId:"",latestTimestamp:0}).diffs?.find(e=>e.path===t);if(!c)return this.toResult(n,!0);let d=n?(0,r.X6)(n,c.diff):(0,r.Gu)(c.diff),h=!1===d?n:d;return this.toResult(h,!0)}catch(t){let e=`Error: ${t instanceof Error?t.message:`Error executing ${this.name} skill`}`;return this.toResult(e,!1)}}constructor(e,t,s){n(this,"id",void 0),n(this,"name",void 0),n(this,"rawArguments",void 0),n(this,"blobService",void 0),this.id=e,this.name=t,this.rawArguments=s,this.blobService=new i.T}}},37304:(e,t,s)=>{function a(e,t,s){if(!t.has(e))throw TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}function i(e,t){var s=a(e,t,"get");return s.get?s.get.call(e):s.value}function r(e,t,s){!function(e,t){if(t.has(e))throw TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.set(e,s)}function n(e,t,s){var i=a(e,t,"set");return!function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw TypeError("attempted to set read only private field");t.value=s}}(e,i,s),s}s.d(t,{Es:()=>ObservableMap,Lj:()=>ObservableValue,yy:()=>ObservableSet});var o=new WeakMap;let l=class ObservableBase{subscribe(e){return i(this,o).add(e),()=>{i(this,o).delete(e)}}notify(e){for(let t of i(this,o))t(e)}constructor(){r(this,o,{writable:!0,value:new Set})}};var c=new WeakMap;let ObservableValue=class ObservableValue extends l{get value(){return i(this,c)}set value(e){var t;t=i(this,c),("object"==typeof e&&e&&"object"==typeof t&&t?function(e,t){for(let s of new Set(Object.keys(e).concat(Object.keys(t))))if(!Object.is(e[s],t[s]))return!0;return!1}(t,e):!Object.is(t,e))&&(n(this,c,e),this.notify(e))}constructor(e){super(),r(this,c,{writable:!0,value:void 0}),n(this,c,e)}};var d=new WeakMap,h=new WeakMap;let ObservableSet=class ObservableSet extends l{get value(){return i(this,d)}has(e){if(!i(this,h).has(e)){let t=new ObservableValue(i(this,d).has(e));i(this,h).set(e,t)}return i(this,h).get(e)}add(e){i(this,d).has(e)||(i(this,d).add(e),i(this,h).has(e)&&(i(this,h).get(e).value=!0),this.notify(i(this,d)))}delete(e){i(this,d).has(e)&&(i(this,d).delete(e),i(this,h).has(e)&&(i(this,h).get(e).value=!1),this.notify(i(this,d)))}clear(){if(0!==i(this,d).size){for(let e of(i(this,d).clear(),i(this,h).values()))e.value=!1;this.notify(i(this,d))}}constructor(...e){super(),r(this,d,{writable:!0,value:void 0}),r(this,h,{writable:!0,value:new Map}),n(this,d,new Set(...e))}};var u=new WeakMap,p=new WeakMap,m=new WeakMap;let ObservableMap=class ObservableMap extends l{get value(){return i(this,u)}has(e){if(!i(this,p).has(e)){let t=new ObservableValue(i(this,u).has(e));i(this,p).set(e,t)}return i(this,p).get(e)}get(e){if(!i(this,m).has(e)){let t=new ObservableValue(i(this,u).get(e));i(this,m).set(e,t)}return i(this,m).get(e)}set(e,t){i(this,u).get(e)!==t&&(i(this,u).set(e,t),i(this,p).has(e)&&(i(this,p).get(e).value=!0),i(this,m).has(e)&&(i(this,m).get(e).value=t),this.notify(i(this,u)))}delete(e){i(this,u).has(e)&&(i(this,u).delete(e),i(this,p).has(e)&&(i(this,p).get(e).value=!1),i(this,m).has(e)&&(i(this,m).get(e).value=void 0),this.notify(i(this,u)))}clear(){if(0!==i(this,u).size){for(let e of(i(this,u).clear(),i(this,p).values()))e.value=!1;for(let e of i(this,m).values())e.value=void 0;this.notify(i(this,u))}}constructor(...e){super(),r(this,u,{writable:!0,value:void 0}),r(this,p,{writable:!0,value:new Map}),r(this,m,{writable:!0,value:new Map}),n(this,u,new Map(...e))}}},10124:(e,t,s)=>{s.d(t,{AI:()=>r,HN:()=>l,R:()=>n,Rs:()=>o,Sk:()=>d,tQ:()=>c});var a=s(96540),i=s(37304);function r(e){let[t]=(0,a.useState)(()=>new i.Lj(e));return t}function n(...e){let[t]=(0,a.useState)(()=>new i.Es(...e));return t}function o(e,t){let s=(0,a.useRef)(t);(0,a.useEffect)(()=>{s.current=t}),(0,a.useEffect)(()=>e.subscribe(e=>s.current(e)),[e])}function l(e){let[t,s]=(0,a.useState)(e.value);return o(e,e=>s(e)),t}function c(e){let[t,s]=(0,a.useState)(e.value),[i,r]=(0,a.useState)({});return o(e,e=>{s(e),r({})}),t}function d(e,t){let s=r(t(e.value));return o(e,e=>{s.value=t(e)}),s}},88117:(e,t,s)=>{s.d(t,{$:()=>h,x:()=>u});var a=s(74848),i=s(96540),r=s(97665),n=s(97286),o=s(57572),l=s(77342);function c(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let CopilotChatEntitlement=class CopilotChatEntitlement{isLicensed(){return this.licenseType&&this.licenseType!==l.mF.Unlicensed}chatQuotaRemaining(){return this.quotas?.remaining.chat??0}constructor(e,t){c(this,"licenseType",void 0),c(this,"quotas",void 0),this.licenseType=e,this.quotas=t}};let d=(0,i.createContext)(void 0);function h({children:e,initialLicenseType:t,initialQuotas:s}){let[c,h]=function(e,t){let s=(0,r.jE)(),a=(0,i.useCallback)(()=>s.invalidateQueries({queryKey:["copilot-chat","entitlement"]}),[s]),{data:c}=(0,n.I)({queryKey:["copilot-chat","entitlement"],queryFn:async()=>{let e=await (0,o.lS)("/github-copilot/chat/entitlement");if(!e.ok)throw Error(`Failed to retrieve Copilot chat entitlement (${e.status} on ${e.url})`);return await e.json()},enabled:e===l.mF.LicensedLimited,placeholderData:{licenseType:e,quotas:t},staleTime:3e5}),d=c?.licenseType??e,h=(0,i.useCallback)(()=>{d===l.mF.LicensedLimited&&a()},[a,d]);return[new CopilotChatEntitlement(d,c?.quotas),h]}(t,s),u=c.licenseType,p=c.chatQuotaRemaining()??1/0,m=c.quotas?.resetDate?new Date(c.quotas.resetDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"",g=u===l.mF.LicensedLimited,f=g&&p<=0,E=(0,i.useMemo)(()=>({licenseType:u,chatQuotaRemaining:p,resetDate:m,isLicensedLimited:g,chatQuotaExceeded:f,reloadQuota:h}),[u,p,m,g,f,h]);return(0,a.jsx)(d.Provider,{value:E,children:e})}let u=()=>{let e=(0,i.useContext)(d);if(!e)throw Error("useEntitlement must be used within EntitlementProvider");return e};try{d.displayName||(d.displayName="EntitlementContext")}catch{}try{h.displayName||(h.displayName="EntitlementProvider")}catch{}},44848:(e,t,s)=>{s.d(t,{Hb:()=>n,nu:()=>l,qw:()=>o});var a=s(74848),i=s(96540);let r=(0,i.createContext)([]);function n({plugins:e,children:t}){return(0,a.jsx)(r.Provider,{value:e,children:t})}function o(){return(0,i.useContext)(r)}function l(e){return o().find(t=>t.id===e)??null}try{r.displayName||(r.displayName="PluginsContext")}catch{}try{n.displayName||(n.displayName="ImmersivePluginsProvider")}catch{}},33492:(e,t,s)=>{s.d(t,{A:()=>c,c:()=>d});var a=s(74848),i=s(96540),r=s(82610);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let CopilotAutocompleteManager=class CopilotAutocompleteManager{async fetchAutocompleteSuggestions(e,t){let[s,a]=await Promise.all([this.manager.service.querySymbols(e,t),this.manager.service.listRepoFiles(e,!0)]);if(s.ok){let t=s.payload.flatMap(t=>t.symbol?[(0,r.Qt)(t,e)]:[]);this.symbolSuggestions=new Map(t.map(e=>[e.name,e]))}if(this.repoSuggestionsCache.has(e.name)){[this.fileSuggestions,this.folderSuggestions]=this.repoSuggestionsCache.get(e.name);return}if(a.ok){let t=new Map,s=new Map;this.repoSuggestionsCache.set(e.name,[t,s]);let i=0,n=[...(a.payload.paths||[]).map(e=>({type:"path",path:e})),...(a.payload.directories||[]).map(e=>({type:"folder",path:e}))],o=()=>{let a=Math.min(i+5e3,n.length);for(;i<a;i++){let a=n[i];if(a?.type==="path"){let s=(0,r.iW)(a.path,e);t.set(s.path,s)}else if(a?.type==="folder"){let t=(0,r.OC)(a.path,e);s.set(t.path,t)}}if(i<n.length)setTimeout(o,0);else{this.fileSuggestions=t,this.folderSuggestions=s;return}};o()}}async addToReferences(e,t){let s=(0,r.Vb)(e);if(this.findReference(s,t))return;let a=e;if((0,r.SI)(e)){let t=await this.manager.service.fetchLanguageForFileReference(e);if(t.ok&&t.payload.language){let{languageName:s,languageId:i}=t.payload.language;a={...e,languageName:s,languageId:i}}}this.manager.addReference(a,"autocomplete")}findReference(e,t){return t.currentReferences.find(t=>e===(0,r.Vb)(t))}constructor(e){n(this,"manager",void 0),n(this,"fileSuggestions",new Map),n(this,"folderSuggestions",new Map),n(this,"symbolSuggestions",new Map),n(this,"repoSuggestionsCache",new Map),this.manager=e}};var o=s(7426);let l=(0,i.createContext)(null);function c({children:e}){let t=(0,o.b)(),s=(0,i.useMemo)(()=>new CopilotAutocompleteManager(t),[t]);return(0,a.jsx)(l.Provider,{value:s,children:e})}function d(){return(0,i.useContext)(l)}try{l.displayName||(l.displayName="CopilotChatAutocompleteContext")}catch{}try{c.displayName||(c.displayName="CopilotChatAutocompleteProvider")}catch{}},65615:(e,t,s)=>{s.d(t,{Mj:()=>M,IJ:()=>G,Pk:()=>P,pn:()=>N,A3:()=>x,bP:()=>B});var a=s(74848),i=s(10124),r=s(79317),n=s(38568),o=s(96540),l=s(18312),c=s(88117);let d=(0,s(80688).A)("sessionStorage");function h(e,t){return!!e&&"assistive"===t}let u="restored-chat-messages";var p=s(46988),m=s(82610),g=s(93589),f=s(2622),E=s(37937);let y=(e,t)=>{let s=(t,s=null)=>{t&&(E.J.selectedThreadID=t);let a=t!==e.selectedThreadID,i=E.J.getModel(t)?.id,r=e.availableModels?.find(e=>e.id===i)??e.model;return{...e,model:r,selectedThreadID:t,currentView:"thread",showTopicPicker:!t&&e.showTopicPicker,customCopilotId:s,currentReferences:a?[]:e.currentReferences,threadHasNewMessages:!a&&e.threadHasNewMessages}},a=t=>(E.J.setCurrentReferences(e.selectedThreadID,t),{...e,currentReferences:t});switch(t.type){case"SLASH_COMMANDS_ERROR":return(0,p.BI)("copilot.slash_commands_error"),{...e,slashCommandLoading:{...e.slashCommandLoading,state:"error"}};case"SLASH_COMMANDS_LOADED":return(0,p.BI)("copilot.slash_commands_loaded"),{...e,slashCommandLoading:{...e.slashCommandLoading,state:"loaded"}};case"SLASH_COMMANDS_LOADING":return{...e,slashCommandLoading:{...e.slashCommandLoading,state:"loading"}};case"OPEN_COPILOT_CHAT":return(0,p.BI)("copilot.open_copilot_chat",{source:t.source}),{...e,chatIsOpen:!0,chatIsVisible:!0,entryPointId:t.id};case"CLOSE_COPILOT_CHAT":return(0,p.BI)("copilot.close_copilot_chat"),{...e,chatIsOpen:!1};case"HIDE_COPILOT_CHAT":return(0,p.BI)("copilot.hide_copilot_chat"),{...e,chatIsVisible:!1};case"THREAD_CREATED":return(0,p.BI)("copilot.thread_created",{...S(t.thread),mode:e.mode,count:e.threads.size+1}),{...s(t.thread.id,t.thread.customCopilotID),threads:new Map(e.threads.set(t.thread.id,t.thread))};case"THREAD_CONTINUED":return(0,p.BI)("copilot.thread_continued",{...S(t.thread),mode:e.mode,count:e.threads.size+1}),{...s(t.thread.id,t.thread.customCopilotID),threads:new Map(e.threads.set(t.thread.id,t.thread))};case"SUGGESTIONS_GENERATED":return{...e,suggestions:t.suggestions};case"CLEAR_SUGGESTIONS":return{...e,suggestions:null};case"CLEAR_THREAD":return(0,p.BI)("copilot.clear_thread"),{...e,messages:[],currentReferences:[]};case"CLEAR_REFERENCES":return{...e,currentReferences:e.currentReferences.filter(e=>"docset"===e.type||"magic-knowledge-base"===e.type)};case"CLEAR_CURRENT_REFERENCES":{(0,p.BI)("copilot.clear_current_references");let s=[],{shouldNotClear:a}=t;return a&&(s=e.currentReferences.filter(e=>a.includes("image")&&"image"===e.type?f.W.attachImagesImmersive:a.includes(e.type))),{...e,currentReferences:s,action:"CLEAR_CURRENT_REFERENCES"}}case"MESSAGES_UPDATED":{let s=t.messages?[...t.messages]:[];if("error"===t.state&&(0,p.BI)("copilot.messages_updated",{count:t.messages?.length,loading:t.state}),!s)return{...e,messagesLoading:{...e.messagesLoading,state:t.state,missingOrgIds:t.missingOrgIds,notFound:t.notFound}};{let a=e.defaultRecipient,i=e.allClientConfirmations;for(let r of("loaded"===t.state&&s.length>0&&(a=I(s[s.length-1],e),i=s.map(e=>e.clientConfirmations?.map(e=>JSON.stringify(Object.values(e.confirmation).sort()))).flat().filter(Boolean)),s))r.clientSide=!1;return s=(0,g.zh)(s),{...e,defaultRecipient:a,allClientConfirmations:i,messages:s,messagesLoading:{...e.messagesLoading,state:t.state,missingOrgIds:t.missingOrgIds,notFound:t.notFound},messagesRestored:!1}}}case"WAITING_ON_COPILOT":return{...e,isWaitingOnCopilot:t.loading,threadHasNewMessages:!0};case"SELECT_THREAD":{let a=t.customCopilotId||t.thread?.customCopilotID||null;(0,p.BI)("copilot.select_thread",{threadID:t.thread?.id,mode:e.mode,customCopilotId:a});let i={...s(t.thread?.id||null,a),currentTopic:t.clearTopic?void 0:e.currentTopic,topicLoading:t.clearTopic?{error:null,state:"loaded"}:e.topicLoading};return null===t.thread&&e.currentRepository&&f.W.topicsAsReferences&&(i.currentReferences=[(0,m.qS)(e.currentRepository)]),i}case"HANDLE_EVENT_START":return(0,p.BI)("copilot.handle_event_start"),{...t.references?a(t.references):e,chatIsOpen:!0,chatIsVisible:!0,entryPointId:t.id};case"THREADS_LOADING":return{...e,threadsLoading:{...e.threadsLoading,state:"loading"}};case"DISMISS_ATTACH_KNOWLEDGE_BASE_HERE_POPOVER":return(0,p.BI)("copilot.dismiss_attach_knowledge_base_here_popover"),{...e,renderAttachKnowledgeBaseHerePopover:!1};case"DISMISS_KNOWLEDGE_BASE_ATTACHED_TO_CHAT_POPOVER":return(0,p.BI)("copilot.dismiss_knowledge_base_attached_to_chat_popover"),{...e,renderKnowledgeBaseAttachedToChatPopover:!1};case"KNOWLEDGE_BASES_LOADING":return{...e,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"loading"}};case"KNOWLEDGE_BASES_LOADED":return(0,p.BI)("copilot.knowledge_bases_loaded",{count:t.knowledgeBases.length}),{...e,knowledgeBases:t.knowledgeBases,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"loaded",error:null}};case"KNOWLEDGE_BASES_LOADING_ERROR":return(0,p.BI)("copilot.knowledge_bases_loading_error",{error:t.message}),{...e,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"error",error:t.message}};case"LATEST_THREAD_LOADED":return{...e,threads:new Map(e.threads.set(t.latestThread.id,t.latestThread))};case"THREADS_LOADED":return(0,p.BI)("copilot.threads_loaded",{count:t.threads.length,mode:e.mode}),{...e,threadsLoading:{...e.threadsLoading,state:"loaded"},threads:new Map(t.threads.map(e=>[e.id,e]))};case"THREADS_LOADING_ERROR":return(0,p.BI)("copilot.threads_loading_error",{error:t.message}),{...e,threadsLoading:{error:t.message,state:"error"}};case"DELETE_THREAD_KEEP_SELECTION":return(0,p.BI)("copilot.thread_deleted",{...S(t.thread),count:e.threads.size-1}),e.threads.delete(t.thread.id),{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[],currentView:"list"};case"DELETE_ALL_THREADS_KEEP_SELECTION":for(let s of t.threads)(0,p.BI)("copilot.thread_deleted",{...S(s),count:e.threads.size-1}),e.threads.delete(s.id);return{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[],currentView:"list"};case"DELETE_THREAD":if((0,p.BI)("copilot.thread_deleted",{...S(t.thread),count:e.threads.size-1,mode:e.mode}),e.threads.delete(t.thread.id),e.selectedThreadID===t.thread.id)return{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[]};return{...e,threads:new Map(e.threads)};case"DELETE_THREAD_ERROR":return(0,p.BI)("copilot.delete_thread_error",{...S(t.thread),error:t.error}),{...e,threadsLoading:{...e.threadsLoading,error:t.error},threads:new Map(e.threads.set(t.thread.id,t.thread))};case"DELETE_ALL_THREADS_ERROR":{for(let e of t.threads)(0,p.BI)("copilot.delete_thread_error",{...S(e),error:t.error});let s=new Map(e.threads);for(let e of t.threads)s.set(e.id,e);return{...e,threadsLoading:{...e.threadsLoading,error:t.error},threads:s}}case"MESSAGE_ADDED":{(0,p.BI)("copilot.message_added",{...C(t.message),count:e.messages.length+1,repoHasCustomInstructions:!!t.repoHasCustomInstructions,usedRepoCustomInstructions:!!t.usedRepoCustomInstructions});let s=(0,g.HR)(e.messages,t.message);return{...e,messages:s,messagesLoading:{state:"loaded",error:null},threadHasNewMessages:!0}}case"MESSAGE_FEEDBACK":{let s=e.messages.map(e=>({...e})),a=s.find(e=>e.id===t.message.id);if(null==a)return(0,p.BI)("copilot.message_feedback_no_message_found",{...C(t.message)}),e;return a.feedback=t.feedback,{...e,messages:s}}case"MESSAGES_SET_SELECTED_MESSAGE":{let s=(0,g.ws)(e.messages,t.message);return{...e,messages:s,threadHasNewMessages:!1}}case"MESSAGES_UNSELECT_PREVIOUS_MESSAGE":{let s=(0,g.TC)(e.messages,t.message);return{...e,messages:s,threadHasNewMessages:!1}}case"THREAD_UPDATED":return{...e,threads:new Map(e.threads.set(t.thread.id,t.thread)),customCopilotId:e.selectedThreadID===t.thread.id?t.thread.customCopilotID:e.customCopilotId};case"REFERENCES_LOADED":return(0,p.BI)("copilot.references_loaded",{count:t.references.length}),{...e,currentReferences:e.currentReferences.filter(e=>t.references.every(t=>(0,m.Vb)(t)!==(0,m.Vb)(e))).concat(t.references)};case"ADD_REFERENCE":{let s=[...e.currentReferences.filter(e=>!(0,m.x_)(e,t.reference)),t.reference];return s.length>e.currentReferences.length&&(0,p.BI)("copilot.add_reference",{...w(t.reference),source:t.source,count:e.currentReferences.length+1}),{...e,...a(s)}}case"REMOVE_REFERENCES":{let s=t.references;return s.length>0&&(0,p.BI)("copilot.remove_reference",{count:e.currentReferences.length-s.length}),{...a(e.currentReferences.filter(e=>!s.includes(e))),action:"REMOVE_REFERENCES"}}case"SHOW_TOPIC_PICKER":return{...e,showTopicPicker:t.show};case"CURRENT_TOPIC_UPDATED":return t.topic&&(0,p.BI)("copilot.current_topic_updated",{type:t.topic?(0,m.P)(t.topic)?"docset":"repository":"none",mode:e.mode}),{...e,currentTopic:t.topic,topicLoading:{...e.topicLoading,state:t.state}};case"MESSAGE_STREAMING_STARTED":return{...e,isWaitingOnCopilot:!0,streamingMessage:t.message,messages:[...e.messages]};case"MESSAGE_STREAMING_TOKEN_ADDED":return{...e,streamingMessage:e.streamingMessage?{...e.streamingMessage,content:e.streamingMessage.content+t.token}:null};case"MESSAGE_STREAMING_FUNCTION_CALLED":if(e.streamingMessage){let s=e.streamingMessage.skillExecutions||[],a=s.findIndex(e=>"started"===e.status),i=a>=0?s[a]:null,r=s;switch(t.status){case"started":r=[...s,{slug:t.name,status:t.status,arguments:t.arguments,errorMessage:t.errorMessage,references:[]}];break;case"completed":i&&(r[a]={...i,status:t.status,references:t.references});break;case"error":i&&(r[a]={...i,status:t.status,errorMessage:t.errorMessage})}return{...e,streamingMessage:{...e.streamingMessage,skillExecutions:r}}}return e;case"CLIENT_SKILL_CONFIRMATION_REQUEST":return{...e,clientSkillConfirmation:t.confirmation};case"CLIENT_SKILLS_REQUEST":return{...e,streamingMessage:e.streamingMessage?{...e.streamingMessage,clientSkillsRequests:t.toolCalls}:null};case"READ_DOM_SKILL_INVOKED":return{...e,elementMap:t.elementMap};case"MESSAGE_STREAMING_COMPLETED":{let s,a=e.defaultRecipient,i=e.messages;if(e.streamingMessage){a=I(s={...e.streamingMessage,id:t.messageResponse.id,references:t.messageResponse.references,createdAt:t.messageResponse.createdAt,intent:t.messageResponse.intent,copilotAnnotations:t.messageResponse.copilotAnnotations,parentMessageID:t.messageResponse.parentMessageID,model:t.messageResponse.model,clientSide:!1},e),(0,p.BI)("copilot.message_streaming_completed",{...C(s),..._(t.timings),model:e.model?.id,mode:e.mode,count:e.messages.length+1});let r=i.map(e=>({...e}));if(null==r.find(e=>e.id===s?.parentMessageID)){let e=(0,g.B)(r),t=e[e.length-1];void 0!==t&&(t.clientSide&&"user"===t.role?(t.id=s.parentMessageID,t.clientSide=!1):s.parentMessageID=t.id)}i=(0,g.HR)(r,s)}return{...e,defaultRecipient:a,isWaitingOnCopilot:!1,streamingMessage:null,messages:i}}case"MESSAGE_STREAMING_FAILED":return(0,p.BI)("copilot.message_streaming_failed",{...e.streamingMessage?C(e.streamingMessage):{},..._(t.timings),model:e.model?.id,mode:e.mode}),{...e,isWaitingOnCopilot:!1,streamingMessage:null};case"MESSAGE_STREAMING_STOPPED":{let s;let a=g.B(e.messages).findLast(e=>"user"===e.role)?.id;e.streamingMessage?(s={...e.streamingMessage,interrupted:!0,parentMessageID:a},(0,p.BI)("copilot.message_streaming_stopped",{...C(s),..._(t.timings),model:e.model?.id,mode:e.mode,count:e.messages.length+1})):e.isWaitingOnCopilot&&(s={id:crypto.randomUUID(),role:"assistant",threadID:e.selectedThreadID??"",references:[],createdAt:new Date().toISOString(),interrupted:!0,clientSide:!0,parentMessageID:a});let i=e.messages;if(null!=s){let e=i.findLast(e=>"user"===e.role);void 0!==e&&(s.parentMessageID=e.id),i=(0,g.HR)(i,s)}return{...e,isWaitingOnCopilot:!1,streamingMessage:null,messages:i}}case"MESSAGES_CLEAR_LAST_ERROR":{let t=(0,g.B)(e.messages),s=e.messages,a=t[t.length-1],i=a?.error||a?.interrupted,r=s;return i&&(r=s.filter(e=>e.id!==a?.id)),{...e,streamingMessage:null,messages:[...r]}}case"SELECT_REFERENCE":return t.reference&&(0,p.BI)("copilot.select_reference",w(t.reference)),{...e,selectedReference:t.reference};case"MODELS_LOADING":return{...e,modelsLoading:{state:"loaded",error:null}};case"MODELS_LOADING_ERROR":return{...e,modelsLoading:{state:"error",error:t.error}};case"MODELS_LOADED":return{...e,model:(t.models||[]).find(t=>t.id===e.model.id)||e.model,availableModels:t.models};case"SELECT_MODEL":if(t.model?.capabilities?.supports?.vision||(e=a(e.currentReferences.filter(e=>"image"!==e.type))),"immersive"!==e.mode)return e;return(0,p.BI)("copilot.select_model",{model:t.model?.name,mode:e.mode}),{...e,model:t.model};case"VIEW_ALL_THREADS":return{...e,currentView:"list"};case"VIEW_CURRENT_THREAD":return{...e,currentView:"thread"};case"IMPLICIT_CONTEXT_UPDATED":if(!(0,m.yR)(t.context,e.context))return{...e,context:t.context};return e;case"SET_TOP_REPOSITORIES":return{...e,topRepositoriesCache:t.topics};case"SET_AGENTS":return{...e,agents:t.agents};case"SET_CUSTOM_COPILOT":return{...e,customCopilots:e.customCopilots?.map(e=>e.id===t.customCopilot.id?t.customCopilot:e)??[t.customCopilot]};case"SET_CUSTOM_COPILOTS":return{...e,customCopilots:t.customCopilots};case"SET_CUSTOM_COPILOT_ID":return{...e,customCopilots:e.customCopilots,customCopilotId:t.customCopilotId};case"DELETE_COPILOT_SPACE":(0,p.BI)("copilot.copilot_space_deleted",{...T(t.copilot),count:(e.customCopilots?.length??0)-1,mode:e.mode});{let s=e.customCopilots?.filter(e=>e.id!==t.copilot.id);if(e.customCopilotId!==t.copilot.id)return{...e,customCopilots:s};return{...e,...{...e,customCopilotId:null},customCopilots:s,messages:[],currentReferences:[]}}case"DELETE_COPILOT_SPACE_ERROR":return(0,p.BI)("copilot.delete_copilot_space_error",{...T(t.copilot),error:t.error}),{...e,customCopilots:e.customCopilots};case"MESSAGE_STREAMING_CONFIRMATION":{let s={title:t.title,message:t.message,confirmation:t.confirmation};return{...e,streamingMessage:e.streamingMessage?{...e.streamingMessage,confirmations:e.streamingMessage.confirmations?[...e.streamingMessage.confirmations,s]:[s]}:null}}case"AGENT_ERROR":{let s=e.streamingMessage,a=t.error;return{...e,streamingMessage:s&&{...s,agentErrors:[...s.agentErrors??[],{type:a.type,code:a.code,message:a.message,identifier:a.identifier}]}}}case"ENTITLEMENT_UPDATED":return{...e,entitlement:t.entitlement??e.entitlement};case"TOGGLE_REPO_CUSTOM_INSTRUCTIONS":return(0,p.BI)("copilot.repo_custom_instructions_toggled",{isEnabling:!!t.value}),{...e,repoCustomInstructionsEnabled:t.value};case"DISMISS_EDITOR_UPSELL_BANNER":return{...e,isEditorUpsellBannerDismissed:!0};case"DISMISS_AMBIENT_ERROR":return{...e,ambientError:null};case"ADD_AMBIENT_ERROR":return{...e,ambientError:{message:t.message}};case"SET_PERSONAL_INSTRUCTIONS":return{...e,personalInstructions:t.personalInstructions};case"SELECT_PLUGIN":return{...e,activePlugin:t.plugin??void 0};case"SHARED_THREAD_UPDATED":return(0,p.BI)("copilot.shared_thread_update",S(t.thread)),{...e,threads:new Map(e.threads.set(t.thread.id,t.thread))};case"IMAGE_UPLOADED":return{...e,currentReferences:e.currentReferences.map(e=>"image"===e.type&&e.id===t.referenceId?{...e,imageUrl:t.dotcomAttachment.previewUrl}:e)}}};function C(e){var t;if(!e)return(0,p.Ti)({});let s={id:e.id,role:e.role,createdAt:e.createdAt,threadID:e.threadID,referenceCount:e.references?.length??0};return e.intent&&(s.intent=e.intent),e.error&&(s.error=e.error),e.copilotAnnotations&&(s.copilotAnnotations=function(e){if(e)return{CodeVulnerability:e.CodeVulnerability?.map(e=>({details:{type:e?.details?.type}})),PublicCodeReference:e.PublicCodeReference?.map(e=>({details:{license:e?.details?.license,language:e?.details?.language}}))}}(e.copilotAnnotations)),e.skillExecutions&&(s.skillExecutions=(t=e.skillExecutions)?t.map(e=>({slug:e?.slug,status:e?.status,argumentCount:e?.arguments?.length??0,errorMessage:e?.errorMessage,references:e?.references?.length??0})):[]),e.interrupted&&(s.interrupted=!0),(0,p.Ti)(s)}function S(e){return e?(0,p.Ti)({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,currentReferenceCount:e.currentReferences?.length??0}):(0,p.Ti)({})}function T(e){return e?(0,p.Ti)({id:e.id}):(0,p.Ti)({})}function w(e){return e?(0,p.Ti)({type:e.type}):(0,p.Ti)({})}function _(e){let t={totalTime:e.endTime-e.startTime};return void 0!==e.firstByte&&(t.ttfb=e.firstByte-e.startTime),void 0!==e.firstToken&&(t.ttft=e.firstToken-e.startTime),t}function I(e,t){let s=(0,m.Th)(e,t.currentUserLogin);if("agent"===s.type)return s.name}var R=s(33492),v=s(7426),D=s(27297),A=s(22232);let k=(0,r.E7)(),b=(0,o.createContext)(null);function M({children:e,topic:t,workerPath:s,threadId:i,copilotSpaceId:r,pluginId:n,refs:p,selectedReference:m,mode:C,ssoOrganizations:S,chatIsOpen:T,chatIsVisible:w,chatVisibleSettingPath:_,agents:I,customCopilots:A,messages:M,testReducerState:L,realIp:P,currentView:N,copilotUpsellBannerDismissed:x,copilotChatPayload:B}){let G=function(e,t){let s=h(e,t),a=d.getItem(u),i=a?JSON.parse(a):void 0;return((0,o.useEffect)(()=>{d.removeItem(u)},[]),s&&i?.expiry&&i.expiry>Date.now()&&i.threadId===e)?{restoredMessages:i.restoredMessages,restoredThreadTitle:i.threadTitle}:{}}(i,C),U=G.restoredMessages,H=G.restoredThreadTitle;U&&(U=(0,g.zh)(U));let q=t?{...t,type:"repository"}:void 0,$=L||{threadsLoading:{state:"pending",error:null},messagesLoading:{state:"pending",error:null},messagesRestored:!!U,slashCommandLoading:{state:"pending",error:null},showTopicPicker:"immersive"!==C&&(!i||"assistive"===C)&&!t,topicLoading:{state:"pending",error:null},threads:new Map,restoredThreadTitle:H,knowledgeBasesLoading:{state:"pending",error:null},knowledgeBases:[],model:D.UB,availableModels:[D.UB],modelsLoading:{state:"pending",error:null},messages:M??U??[],streamingMessage:null,selectedThreadID:i,currentTopic:f.W.topicsAsReferences?void 0:t,chatIsOpen:!!T,isWaitingOnCopilot:!1,currentUserLogin:B.currentUserLogin,apiUrl:B.apiURL,currentReferences:f.W.topicsAsReferences&&q?[q,...p]:p,findFileWorkerPath:s,currentView:N||"thread",selectedReference:m??null,mode:C,currentRepository:t,ssoOrganizations:S,context:void 0,renderKnowledgeBases:B.renderKnowledgeBases??!0,renderAttachKnowledgeBaseHerePopover:B.renderAttachKnowledgeBaseHerePopover,renderKnowledgeBaseAttachedToChatPopover:B.renderKnowledgeBaseAttachedToChatPopover,customInstructions:B.customInstructions,chatIsVisible:w,chatVisibleSettingPath:_,renderBetaLabel:B.renderBetaLabel,topRepositoriesCache:void 0,agentsPath:B.agentsPath,optedInToPreviewFeatures:B.optedInToPreviewFeatures,optedInToUserFeedback:B.optedInToUserFeedback,agents:I,customCopilots:A,customCopilotId:null,activePlugin:n??void 0,reviewLab:B.reviewLab,repoCustomInstructionsEnabled:E.J.getRepoCustomInstructionsState(),isEditorUpsellBannerDismissed:x,ambientError:void 0,personalInstructions:B.personalInstructions??null,threadHasNewMessages:!1},[W,j]=(0,o.useReducer)(y,$);return!function(e,t,s,a){let i=h(t,a);(0,o.useEffect)(()=>{if(!i)return;let a=(e,t)=>{if("childMessages"!==e&&"parentMessage"!==e)return t},r=()=>{if(!e?.length||!t)return;let i=s.get(t),r=i?.name,n={expiry:Date.now()+8e3,restoredMessages:e,threadId:t,threadTitle:r};d.setItem(u,JSON.stringify(n,a))};return window.addEventListener("turbo:before-fetch-response",r),window.addEventListener("beforeunload",r),window.addEventListener("popstate",r),()=>{window.removeEventListener("turbo:before-fetch-response",r),window.removeEventListener("beforeunload",r),window.removeEventListener("popstate",r)}},[e,i,t,s])}(W.messages,W.selectedThreadID,W.threads,W.mode),(0,o.useEffect)(()=>{if(r){let e=Number(r);isNaN(e)||j({type:"SET_CUSTOM_COPILOT_ID",customCopilotId:e})}},[r]),(0,a.jsx)(c.$,{initialLicenseType:B.licenseType,initialQuotas:B.quotas,children:(0,a.jsx)(O,{state:W,children:(0,a.jsx)(b.Provider,{value:j,children:(0,a.jsx)(v.v,{apiURL:B.apiURL,state:W,dispatch:j,ssoOrganizations:S,realIp:P,hasCEorCBAccess:B.hasCEorCBAccess,children:(0,a.jsx)(R.A,{children:(0,a.jsx)(l.RelayEnvironmentProvider,{environment:k,children:e})})})})})})}let L=(0,o.createContext)(null);function O({state:e,children:t}){let s=(0,i.AI)(e);return(0,n.N)(()=>{s.value=e},[e,s]),(0,a.jsx)(A.sw,{value:s,children:(0,a.jsx)(L.Provider,{value:e,children:t})})}function P(){let e=(0,o.useContext)(L);if(!e)throw Error("useChatState can only be used inside a CopilotChatProvider");return e}function N(e){let t=(0,A.rE)();if(!t)throw Error("useChatStateLens can only be used inside a CopilotChatProvider");let s=(0,i.Sk)(t,e);return(0,i.HN)(s)}function x(e){return N(t=>t[e])}function B(...e){return N(t=>(function(e,t){let s={};for(let a of t)s[a]=e[a];return s})(t,e))}function G(){let e=(0,o.useContext)(b);if(!e)throw Error("useChatDispatch can only be used inside a CopilotChatProvider");return e}try{b.displayName||(b.displayName="CopilotChatDispatchContext")}catch{}try{M.displayName||(M.displayName="CopilotChatProvider")}catch{}try{L.displayName||(L.displayName="ChatStateContext")}catch{}try{O.displayName||(O.displayName="ChatStateProvider")}catch{}},7426:(e,t,s)=>{s.d(t,{b:()=>m,v:()=>p});var a=s(74848),i=s(70170),r=s(96540),n=s(88117),o=s(44848),l=s(53914),c=s(2622),d=s(37937),h=s(22232);let u=(0,r.createContext)(null);function p({apiURL:e,state:t,dispatch:s,ssoOrganizations:p,children:m,realIp:g,hasCEorCBAccess:f}){let E=(0,h.tD)(),y=(0,o.qw)(),C=(0,r.useMemo)(()=>new l.e8(s,e,p,E,g,void 0,f,y),[s,e,p,E,g,f,y]),{licenseType:S}=(0,n.x)();return(0,r.useEffect)(()=>{t.chatIsOpen&&!c.W.topicsAsReferences&&(async()=>{if(t.selectedThreadID&&t.messages.length>0&&!t.currentTopic){let e=d.J.getSelectedTopic(t.selectedThreadID),s=Number(e);e&&!isNaN(s)?await C.fetchCurrentRepo(s):C.clearCurrentTopic()}})()},[t.selectedThreadID,C,t.messages.length,t.currentTopic,t.chatIsOpen]),(0,r.useEffect)(()=>{let e=new AbortController,s=async()=>{let e=window.location.hash,t=window.location.pathname,s=window.location.hash?`${t}${e}`:t,a=s.slice(1).split("/");if(a.length<2)return;let i=a[0],r=a[1];i&&r&&await C.fetchImplicitContext(s,i,r)},a=(0,i.s)(()=>{s()},500);return t.chatIsOpen&&(a(),function(){let{replaceState:t}=window.history;window.history.replaceState=function(...e){t.apply(window.history,e),C.clearSuggestions(),window.dispatchEvent(new Event("replaceState"))},window.addEventListener("popstate",a,{signal:e.signal}),window.addEventListener("replaceState",a,{signal:e.signal})}()),()=>{e.abort()}},[C,t.chatIsOpen,S]),(0,a.jsx)(u.Provider,{value:C,children:m})}function m(){let e=(0,r.useContext)(u);if(!e)throw Error("useChatManager must be used within a CopilotChatManagerProvider");return e}try{u.displayName||(u.displayName="CopilotChatManagerContext")}catch{}try{p.displayName||(p.displayName="CopilotChatManagerProvider")}catch{}},22232:(e,t,s)=>{s.d(t,{rE:()=>o,sw:()=>r,tD:()=>n});var a=s(96540);let i=(0,a.createContext)(null),r=i.Provider;function n(){let e=(0,a.useContext)(i);if(!e)throw Error("useGetChatState can only be used inside a CopilotChatProvider");return(0,a.useCallback)(()=>e.value,[e])}function o(){return(0,a.useContext)(i)}try{i.displayName||(i.displayName="ObservableChatStateContext")}catch{}},53914:(e,t,s)=>{s.d(t,{e8:()=>CopilotChatManager,SL:()=>L,L9:()=>P,AG:()=>O});var a,i=s(74848),r=s(46988),n=s(57572),o=s(96558),l=s(82610),c=s(55854),d=s(37404),h=s(93589),u=s(77342),p=s(2622),m=s(37937),g=s(27297),f=s(75632);let E={interactDomSkillHighlight:"interact-dom-module__interactDomSkillHighlight--nDwwz"};function y(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let InteractDomSkill=class InteractDomSkill{requiresConfirmation(){return"click"===JSON.parse(this.rawArguments).action}confirmationMessage(){let e=JSON.parse(this.rawArguments),t="";switch(e.action){case"click":t=`Click on ${e.element}`;break;case"type":t=`Type "${e.value}" into ${e.element}`}return t}static schema(){return{type:"function",function:{name:"interact-dom",description:"This function gives you the ability to interact with the DOM. Perform an action like clicking on an element, typing into an input, or filling out a form on the current html page. Call this function to fulfill the user request after receiving the current url and tag map of accessible element names to their tags from invoking the read-dom function. For the type action, if there is existing text in the element (passed in the tag map), you should modify that text how the user requests and return the new text contents. Do no just return the new text the user asked you to type unless they are explicitly trying to overwrite the current value. Afterwards, you should send a message letting the user know the actions you performed. If the user makes multiple requests in one message, you should invoke this function multiple times in a single reposnse.",parameters:{type:"object",required:["action","element"],properties:{action:{type:"string",description:'The DOM action to take on an element on the current page. The action property can either be "click" or "type". If it is "type" then the value property should be the string to type into the input element.'},element:{type:"string",description:"The accessible name of the element to perform the DOM action on. This must be one of the keys in the tag map returned from read-dom."},value:{type:"string",description:"If the action is 'type', then value is the string to type into the text input element. The text input's value will be set to this, so if the element has an existing value from the tag map passed in, make sure to include that in this paramter."}}}}}}async execute(){try{let e=JSON.parse(this.rawArguments),t=this.chatState?.elementMap?.get(e.element),s="";if(t instanceof HTMLElement)switch(t.classList.add(E.interactDomSkillHighlight),document.addEventListener("click",()=>{t.classList.remove(E.interactDomSkillHighlight)},{once:!0}),e.action){case"click":t.click(),s=`${e.element} was clicked.`;break;case"type":"value"in t?(t.value="",await function(e,t,s=0){return new Promise(a=>{!function s(i){if(i<t.length){let a=t.charAt(i),r=new KeyboardEvent("keydown",{key:a,code:`Key${a.toUpperCase()}`,keyCode:a.charCodeAt(0),charCode:a.charCodeAt(0),bubbles:!0});e.dispatchEvent(r),e.value+=a,setTimeout(()=>s(i+1),10)}else{let t=new Event("input",{bubbles:!0});e.dispatchEvent(t),a()}}(s)})}(t,e.value||""),s=`${e.value} was typed into ${e.element}.`):s=`${e.element} could not be typed into because it was not an element that accepts a value like textarea or input.`}else s=`${e.element} could not be located.`;return{result:s,ok:!0}}catch(e){return{ok:!1,result:`Error: ${e instanceof Error?e.message:`Error executing ${this.name} skill`}`}}}constructor(e,t,s,a){y(this,"id",void 0),y(this,"name",void 0),y(this,"rawArguments",void 0),y(this,"chatState",void 0),this.id=e,this.name=t,this.rawArguments=s,this.chatState=a}};function C(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let S={workbench:!0};let NavigateInternallySkill=class NavigateInternallySkill{requiresConfirmation(){return!1}confirmationMessage(){return"Navigate to the specified location"}static schema(){return{type:"function",function:{name:"navigate-internally",description:`
    This tool is used to redirect the user to a handful of internal locations that have been predefined. Only the predefined list of locations will be allowed, and any other location will be rejected and cause an error.

    Locations are defined as [slug]: [description]. Use the slug when calling this tool.

    Locations:
    - workbench: A specialized location for helping the user with creating, building, testing, and running code, websites and more. This area should be preferred for any situation where the user wants to build an app, website, or do any sort of extensive coding.
    `,parameters:{type:"object",required:["location","reasoning"],properties:{location:{description:"The location slug to navigate the user.",type:"string",enum:["workbench"]},reasoning:{type:"string",description:`The reasoning for why this task is a good candidate for the location. We will display this to the user for confirmation.

                This field should be formatted as follows: "We think this would be a good task for [location] [because] <reasoning>."
                `}}}}}}execute(){try{let e=JSON.parse(this.rawArguments);if(!this.chatState?.selectedThreadID)return{ok:!1,result:"No active thread found. Cannot redirect."};if(!S[e.location])return{ok:!1,result:`Location ${e.location} is not valid.`};if("workbench"===e.location){let e=this.chatState?.messages.find(e=>"user"===e.role&&"temp"===e.threadID);if(!e||!e.content)return{ok:!1,result:"We couldn't find the last user message, so we can't redirect, let's build here"};let t=encodeURIComponent(e.content);return window.location.href=`/copilot/spark?initialPrompt=${t}`,{ok:!0,result:"The user is now in the workbench. Our job is done, wish them luck in less than 5 words."}}return{ok:!1,result:"Location is not valid."}}catch(e){return{ok:!1,result:`Error: ${e instanceof Error?e.message:"Error executing redirect to workbench"}`}}}constructor(e,t,s,a,i){C(this,"id",void 0),C(this,"name",void 0),C(this,"rawArguments",void 0),C(this,"chatState",void 0),C(this,"dispatch",void 0),this.id=e,this.name=t,this.rawArguments=s,this.chatState=a,this.dispatch=i}};var T=s(6786);function w(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let ReadDomSkill=class ReadDomSkill{requiresConfirmation(){return!1}confirmationMessage(){return"Read the DOM for the current page"}static schema(){return{type:"function",function:{name:"read-dom",description:"Allows you to interact with the DOM to perform actions like filling out forms, submitting forms, clicking on buttons, and typing into inputs on the current web page. This function requests a list of all interactable elements on the current html page, keyed by their accessible name. If the user makes a request to interact with elements on the current web page, but has not provided any DOM elements in clientToolResults, call this function. After the results are returned, call interact-dom to actually perform the desired interactions. If the user asks a question about the DOM, you can call this to read its state, but do not follow up with an interact-dom function call in that case. Finally, let the user know what actions you performed",parameters:{type:"object",properties:{}}}}}execute(){try{let e={},t=new Map;for(let s of document.querySelectorAll('input, select, textarea, button, [role="button"], a, [tabindex]')){let a=(0,T.G3)(s);t.set(a,s);let i=s.tagName,r=s instanceof HTMLInputElement||s instanceof HTMLTextAreaElement?s.value:null;e[a]={tag:i,value:r}}return this.dispatch?.({type:"READ_DOM_SKILL_INVOKED",elementMap:t}),{result:JSON.stringify({tagMap:e,url:window.location.href}),ok:!0}}catch(e){return{ok:!1,result:`Error: ${e instanceof Error?e.message:`Error executing ${this.name} skill`}`}}}constructor(e,t,s,a,i){w(this,"id",void 0),w(this,"name",void 0),w(this,"rawArguments",void 0),w(this,"dispatch",void 0),this.id=e,this.name=t,this.rawArguments=s,this.dispatch=i}};var _=s(84310);let I=/^\/settings\/.*/,R={"read-local-workspace-file":{constructor:_.K,schema:_.K.schema(),includePaths:[/^\/[^/]+\/[^/]+\/pull\/\d+\/edit$/],featureFlag:"workspace_editor_fix_a_build_function_calling"},"read-dom":{constructor:ReadDomSkill,schema:ReadDomSkill.schema(),excludePaths:[I],featureFlag:"copilot_client_dom_skills"},"interact-dom":{constructor:InteractDomSkill,schema:InteractDomSkill.schema(),excludePaths:[I],featureFlag:"copilot_client_dom_skills"},"navigate-internally":{constructor:NavigateInternallySkill,schema:NavigateInternallySkill.schema(),includePaths:[/^\/copilot(\/.*)?$/],featureFlag:"copilot_workbench"}},v=e=>Object.keys(R).reduce((t,s)=>{let a=R[s];if(!a||a.featureFlag&&!(0,f.G7)(a.featureFlag))return t;if(A(a)){if(a.excludePaths.some(t=>t.test(e)))return t}else if(!D(a))return t;else if(!a.includePaths.some(t=>t.test(e)))return t;return t.push(a.schema),t},[]),D=e=>"includePaths"in e,A=e=>"excludePaths"in e;function k(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let UnknownClientSkill=class UnknownClientSkill{requiresConfirmation(){return!1}confirmationMessage(){return"Unknown function"}execute(){return{ok:!0,result:`Unknown function: ${this.name} called with args: ${this.rawArguments}`}}schema(){return{type:"function",function:{name:"unknown-client-skill",description:"This is a fallback skill if the skill is not found"}}}constructor(e,t,s,a,i){k(this,"id",void 0),k(this,"name",void 0),k(this,"rawArguments",void 0),k(this,"chatState",void 0),k(this,"dispatch",void 0),this.id=e,this.name=t,this.rawArguments=s,this.chatState=a,this.dispatch=i}};function b(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let SkillExecutor=class SkillExecutor{async run(){if(this.requiresConfirmation()){let e=this.clientSkillConfirmation();this.dispatch({type:"CLIENT_SKILL_CONFIRMATION_REQUEST",confirmation:e})}else await this.executeSkills()}setParentMessageId(e){this.parentMessageId=e}resetExecution(){this.parentMessageId=void 0,this.skillsToExecute=[]}clientSkillConfirmation(){return{title:"Confirm actions",message:this.confirmationMessage(),onSubmit:e=>{this.dispatch({type:"CLIENT_SKILL_CONFIRMATION_REQUEST",confirmation:void 0}),e?this.executeSkills():this.sendChatMessage({thread:this.thread,content:"",references:[],clientToolResults:this.confirmationDeclinedResults()}),this.resetExecution()},confirmation:{toolCalls:this.toolCalls}}}confirmationDeclinedResults(){return this.skillsToExecute.map(e=>({id:e.id,type:"function",functionCallResult:{name:e.name,arguments:e.rawArguments,result:`Failed to execute ${e.name}: Permission denied by user`}}))}validateSkillEntry(e){if(e&&(!e.featureFlag||(0,f.G7)(e.featureFlag)))return e.constructor}toolCallsToSkills(){return this.toolCalls.map(e=>{let t=R[e.function.name],s=this.validateSkillEntry(t);return s?new s(e.id,e.function.name,e.function.arguments,this.chatState,this.dispatch):new UnknownClientSkill(e.id,e.function.name,e.function.arguments,void 0,void 0)})}requiresConfirmation(){return this.skillsToExecute.some(e=>e.requiresConfirmation())}confirmationMessage(){let e="";for(let t of this.skillsToExecute)e+=`${t.confirmationMessage()}
`;return e}async executeSkills(){if(0===this.skillsToExecute.length)return;let e=[];for(let t of this.skillsToExecute){let s=await this.executeSkill(t),a={id:t.id,type:"function",functionCallResult:s};e.push(a)}this.sendChatMessage({thread:this.thread,content:"",references:[],clientToolResults:e,parentMessageId:this.parentMessageId}),this.resetExecution()}async executeSkill(e){try{let{ok:t,result:s}=await e.execute();return(0,r.BI)("dotcom_chat.client_skill_execution",{skillName:e.name,success:t}),{name:e.name,arguments:e.rawArguments,result:s}}catch{return(0,r.BI)("dotcom_chat.client_skill_execution",{skillName:e.name,success:!1}),{name:e.name,arguments:e.rawArguments,result:`Failed to execute ${e.name}`}}}constructor(e,t,s,a,i){b(this,"toolCalls",void 0),b(this,"sendChatMessage",void 0),b(this,"thread",void 0),b(this,"skillsToExecute",void 0),b(this,"chatState",void 0),b(this,"dispatch",void 0),b(this,"parentMessageId",void 0),this.thread=e,this.toolCalls=t,this.sendChatMessage=s,this.chatState=a,this.dispatch=i,this.skillsToExecute=this.toolCallsToSkills()}};function M(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let L="copilot_delete_all_conversations",O="copilot_staff_prompt_dialog",P=99,N=null;let CopilotChatManager=class CopilotChatManager{async openChat(e,t,s,a,i){if(this.dispatch({type:"OPEN_COPILOT_CHAT",source:s}),"thread"===t&&await this.findOrStartNewThread(e,i),m.J.setCollapsedState(!1),H(this.getChatState().entryPointId??o.fv,!0),a){let e=new FormData;e.set("copilot_chat_visible","true"),(0,n.DI)(a,{method:"PUT",body:e})}}closeChat(){this.dispatch({type:"CLOSE_COPILOT_CHAT"}),m.J.setCollapsedState(!0),H(this.getChatState().entryPointId??o.fv,!1)}hideChat(e){if(this.dispatch({type:"HIDE_COPILOT_CHAT"}),this.closeChat(),e){let t=new FormData;t.set("copilot_chat_visible","false"),(0,n.DI)(e,{method:"PUT",body:t})}}toggleRepoCustomInstructions(e){this.dispatch({type:"TOGGLE_REPO_CUSTOM_INSTRUCTIONS",value:e}),m.J.setRepoCustomInstructionsState(e)}viewAllThreads(){this.dispatch({type:"VIEW_ALL_THREADS"})}viewCurrentThread(){this.dispatch({type:"VIEW_CURRENT_THREAD"})}maxMessagesReached(){return this.getChatState().messages.length>=3e3}async sendChatMessage({thread:e,content:t,references:s,topic:a,context:i,confirmations:r,customInstructions:n,model:o,customCopilotId:c,intent:d=u.wh.conversation,tools:h,clientToolResults:m,parentMessageId:g,modeOverride:f}){let E=(0,l.P)(a),y=E?void 0:a;E&&!s.some(e=>"docset"===e.type&&e.name===a.name)&&s.push({type:"docset",name:a.name,id:a.id,avatarUrl:a.avatarUrl,repos:a.repos,description:a.description});let C=p.W.attachImagesImmersive?await Promise.all(s.filter(e=>"image"===e.type).map(e=>e.attachment).map(async e=>{let t=await e.url(),s=e.file;return{mediaType:s.type,name:s.name,url:t,width:e.width,height:e.height}})):[],S=s.filter(e=>"image"!==e.type);return this.sendNewMessage(e,t,C,d,S,y,i,r,n,o,c,h,m,g,f)}FindLastMessageID(){let e=(0,h.B)(this.getChatState().messages);return e[e.length-1]?.id||"root"}async retryLastUnsuccessfulChatMessage(e){let{currentTopic:t,context:s,customInstructions:a,model:i,customCopilotId:r}=this.getChatState(),n=(0,l.P)(t)?void 0:t,o=(0,h.B)(this.getChatState().messages).findLast(e=>"user"===e.role);if(!o?.content)return;let c=e.currentReferences||[],d=o.mediaContent||[];this.dispatch({type:"MESSAGES_CLEAR_LAST_ERROR"}),this.unselectPreviousChildMessage(o);let p="";if(o.clientSide){let e=(0,h.B)(this.getChatState().messages).findLast(e=>!e.clientSide);p=e?"user"===e.role?e.parentMessageID||"root":e.id:"root"}else p=o.id;return this.sendMessage(e,o.content,d,c,u.wh.conversation,s,n,a,i,void 0,r,p)}async retryUserChatMessage(e,t,s){let a;let{currentTopic:i,context:r,customInstructions:n,model:o,customCopilotId:c}=this.getChatState(),d=(0,l.P)(i)?void 0:i;if(t.parentMessageID&&(a=this.getChatState().messages.findLast(e=>e.id===t.parentMessageID)),!a||!a.content)return;this.unselectPreviousChildMessage(a);let h=a.references||[],p=a.mediaContent||[];return this.sendMessage(e,a.content,p,h,u.wh.conversation,r,d,n,s||o,void 0,c,a.id)}async editUserChatMessage(e,t,s){if(!s)return;let{currentTopic:a,context:i,customInstructions:r,messages:n,model:o,customCopilotId:c}=this.getChatState(),d=(0,l.P)(a)?void 0:a,p=(0,h.CX)(n,t);if(!p)return;let m=p?.id||"",g=t.clientConfirmations??[],f=t.references||[],E=t.mediaContent||[],y=(0,l.Y6)({role:"user",content:s,mediaContent:E,references:f,thread:e,confirmationResponses:g,parentMessageID:m}),C=(0,l.lG)(d,f);if(this.dispatch({type:"MESSAGE_ADDED",message:y,repoHasCustomInstructions:!!C,usedRepoCustomInstructions:!!(C&&this.repoInstructionsEnabled())}),this.reloadingThreadPromise&&(this.dispatch({type:"WAITING_ON_COPILOT",loading:!0}),this.afterThreadReloadCallback=()=>{this.dispatch({type:"MESSAGE_ADDED",message:y,repoHasCustomInstructions:!!C,usedRepoCustomInstructions:!!(C&&this.repoInstructionsEnabled())})},!await this.reloadingThreadPromise))return;let S=p;for(;S&&S.clientSide;)S=(0,h.CX)(n,S);return this.sendMessage(e,s,E,f,u.wh.conversation,i,d,r,o,void 0,c,S?.id||"")}handleFeedback(e,t){this.dispatch({type:"MESSAGE_FEEDBACK",message:e,feedback:t})}setSelectedMessage(e){this.dispatch({type:"MESSAGES_SET_SELECTED_MESSAGE",message:e})}unselectPreviousChildMessage(e){this.dispatch({type:"MESSAGES_UNSELECT_PREVIOUS_MESSAGE",message:e})}async stopStreaming(){this.streamer?(await this.streamer.stop(),this.streamer=void 0):this.messageAbortController?.abort(),this.dispatch({type:"MESSAGE_STREAMING_STOPPED",timings:this.completeTiming()})}async getSystemPrompt(){let{mode:e}=this.getChatState();return await this.systemPrompt(e)}async sendNewMessage(e,t,s,a,i,r,n,o,c,d,u,p,g,f,E){let{clientSkillConfirmation:y}=this.getChatState();y&&(this.dispatch({type:"CLIENT_SKILL_CONFIRMATION_REQUEST",confirmation:void 0}),this.skillExecutor?.resetExecution());let C=(0,l.Y6)({role:"user",content:t,mediaContent:s,references:i,thread:e,confirmationResponses:o?[o]:[],parentMessageID:f||this.FindLastMessageID(),clientToolResults:g}),S=(0,l.lG)(r,i);if(this.dispatch({type:"MESSAGE_ADDED",message:C,repoHasCustomInstructions:!!S,usedRepoCustomInstructions:!!(S&&this.repoInstructionsEnabled())}),!e){let s=await this.service.createThread(u);if(s.ok)e=s.payload,m.J.migrateNullThreadToNewThread(e.id),this.dispatch({type:"THREAD_CREATED",thread:e});else{this.handleSendMessageError(e,G(s.error),t);return}}this.dispatch({type:"THREAD_UPDATED",thread:{...e,updatedAt:new Date().toISOString()}}),this.dispatch({type:"CLEAR_REFERENCES",threadID:e.id}),d&&m.J.setModel(e.id,d);let T="";if(!f){let e=(0,h.B)(this.getChatState().messages),t=e[e.length-1];if(f=t?t.clientSide?e.findLast(e=>!e.clientSide&&"assistant"===e.role)?.id||"root":t.id:"root",this.reloadingThreadPromise&&(this.dispatch({type:"WAITING_ON_COPILOT",loading:!0}),this.afterThreadReloadCallback=e=>{0!==e.length&&(T=e[e.length-1].id,C.parentMessageID=T,this.dispatch({type:"MESSAGE_ADDED",message:C,repoHasCustomInstructions:!!S,usedRepoCustomInstructions:!!(S&&this.repoInstructionsEnabled())}))},!await this.reloadingThreadPromise))return}return this.sendMessage(e,t,s,i,a,n,r,c,d,o,u,T||f,p,g,E)}async sendMessage(e,t,s,a,i,n,o,d,h,u,m,g,f=[],E,y){let C=(0,l.Y6)({role:"assistant",content:"",mediaContent:[],thread:e,parentMessageID:g});C.messageIndex=-1,this.dispatch({type:"WAITING_ON_COPILOT",loading:!0});let S=a.length&&(1!==a.length||a[0]?.type!=="repository")?void 0:n;(0,r.BI)("copilot.implicit_context",{usedImplicitContext:!!S,type:S?.[0]?.type,count:S?.length}),!a.length&&o&&(a=[(0,l.qS)(o)]);let T=[];if(this.repoInstructionsEnabled()){if(p.W.topicsAsReferences){let e=(0,l.NJ)(a);T.push(...e.map(e=>e.prompt))}else o?.customInstructions&&T.push(...o.customInstructions.map(e=>e.prompt))}!d||(p.W.topicsAsReferences?(0,l.NJ)(a).find(e=>"Organization"===e.type)||T.push(d):o?.customInstructions?.find(e=>"Organization"===e.type)||T.push(d));let{mode:w}=this.getChatState();this.timings={startTime:Date.now()},this.streamer=void 0,this.messageAbortController=new AbortController;let _=[...f,...v(window.location.pathname)];try{let r={threadID:e.id,messageID:C.id,content:t,mediaContent:s,intent:i,mode:y||w,references:a,context:S??[],confirmations:u?[u]:[],customInstructions:T,model:h?.id,customCopilotID:m,parentMessageID:g,tools:_,clientToolResults:E,signal:this.messageAbortController.signal},n=this.activePlugin?.overrideCreateMessageOptions?await this.activePlugin.overrideCreateMessageOptions(r):r,o=await this.service.createMessageStreaming(n);if(o.ok){let s=o.response.body?.getReader();if(!s){this.handleSendMessageError(e,G(l.DW),t);return}let a=new c.X(s);this.streamer=a,this.dispatch({type:"MESSAGE_STREAMING_STARTED",message:C}),await this.handleStreamingMessage(e,a)}else{if(this.messageAbortController.signal.aborted)return;this.handleSendMessageError(e,G(o.error),t)}}finally{this.streamer=void 0,this.messageAbortController=void 0}}repoInstructionsEnabled(){return(p.W.repoCustomInstructions||p.W.repoCustomInstructionsPreview)&&m.J.getRepoCustomInstructionsState()}addReference(e,t){this.dispatch({type:"ADD_REFERENCE",reference:e,source:t})}removeReference(e){e&&this.dispatch({type:"REMOVE_REFERENCES",references:[e]})}removeReferences(e){this.dispatch({type:"REMOVE_REFERENCES",references:e})}setImageAttachmentUploaded(e,t){this.dispatch({type:"IMAGE_UPLOADED",referenceId:e,dotcomAttachment:t})}selectModel(e,t){this.dispatch({type:"SELECT_MODEL",model:e}),"url"!==t&&m.J.setModel(this.getChatState().selectedThreadID,e)}selectPlugin(e){(this.getChatState().activePlugin??null)!==e&&(!e||this.plugins.find(t=>t.id===e))&&this.dispatch({type:"SELECT_PLUGIN",plugin:e})}get activePlugin(){return this.plugins.find(e=>e.id===this.getChatState().activePlugin)}setCopilotSettings(e){m.J.settings=e}async dismissAttachKnowledgeBaseHerePopover(){this.dispatch({type:"DISMISS_ATTACH_KNOWLEDGE_BASE_HERE_POPOVER"}),await (0,n.DI)("/settings/dismiss-notice/copilot_for_docs_attach_knowledge_base_here",{method:"POST"})}async dismissKnowledgeBaseAttachedToChatPopover(){this.dispatch({type:"DISMISS_KNOWLEDGE_BASE_ATTACHED_TO_CHAT_POPOVER"}),await (0,n.DI)("/settings/dismiss-notice/copilot_for_docs_knowledge_base_attached_to_chat",{method:"POST"})}async selectThread(e,t){let{clearTopic:s,includeThreads:a=!0,customCopilotId:i}=t??{};await this.fetchModels(),await this.stopStreaming(),this.dispatch({type:"SELECT_THREAD",thread:e,clearTopic:s,customCopilotId:i});let r=[];r.push(this.fetchMessages(e?.id||null)),a&&r.push(this.fetchThreads()),await Promise.all(r)}addMessage(e,t,s,a,i,r,n){let o=(0,l.Y6)({role:e,content:s,mediaContent:a,references:i,thread:t,confirmationResponses:r,clientSkillConfirmations:n,parentMessageID:this.FindLastMessageID()});this.dispatch({type:"MESSAGE_ADDED",message:o})}async renameThread(e,t){(await this.service.renameThread(e.id,t)).ok&&this.dispatch({type:"THREAD_UPDATED",thread:{...e,name:t}})}dismissAmbientError(){this.dispatch({type:"DISMISS_AMBIENT_ERROR"})}addAmbientError(e){this.dispatch({type:"ADD_AMBIENT_ERROR",message:e})}async clearThread(e){(await this.service.clearThread(e.id)).ok&&this.dispatch({type:"CLEAR_THREAD",threadID:e.id})}async deleteThreadKeepSelection(e){this.dispatch({type:"DELETE_THREAD_KEEP_SELECTION",thread:e});let t=await this.service.deleteThread(e.id);t.ok||this.dispatch({type:"DELETE_THREAD_ERROR",thread:e,error:t.error})}async deleteAllThreadKeepSelection(e){this.dispatch({type:"DELETE_ALL_THREADS_KEEP_SELECTION",threads:e});let t=e.map(e=>e.id);for(let s=0;s<t.length;s+=100){let a=t.slice(s,s+100),i=await this.service.deleteAllThreads({threadIDs:a});i.ok||this.dispatch({type:"DELETE_ALL_THREADS_ERROR",threads:e,error:i.error})}}async deleteThread(e){this.dispatch({type:"DELETE_THREAD",thread:e});let t=await this.service.deleteThread(e.id);t.ok||this.dispatch({type:"DELETE_THREAD_ERROR",thread:e,error:t.error})}async deleteCopilotSpace(e){this.dispatch({type:"DELETE_COPILOT_SPACE",copilot:e});let t=await this.service.deleteCopilotSpace(e.id);t.ok||this.dispatch({type:"DELETE_COPILOT_SPACE_ERROR",copilot:e,error:t.error})}generateSuggestions(e){let t=(0,l.mx)(e);this.dispatch({type:"SUGGESTIONS_GENERATED",suggestions:t})}clearSuggestions(){this.dispatch({type:"CLEAR_SUGGESTIONS"})}async handleOpenPanelEvent(e,t,s,a){let i=t.payload,n=!e&&s,c=e&&s;if(x(i)||B(i,[u.wh.conversation])&&"newThread"in i&&i.newThread?(await this.selectThread(null),e=null):B(i,[u.wh.reviewPr])?(this.addMessage("user",i.thread,o.Bc,[],i.references),this.addMessage("assistant",i.thread,i.completion,[],i.references),this.selectThread(i.thread,{includeThreads:!1})):n||(p.W.copilotChatOpeningThreadSwitch?B(i,[u.wh.conversation])&&"attachThread"in i&&i.attachThread&&!s||c?e=await this.findOrStartNewThread(e):(await this.selectThread(null),e=null):e=await this.findOrStartNewThread(e)),this.dispatch({type:"HANDLE_EVENT_START",references:i.references,id:i.id}),B(i,[u.wh.conversation,u.wh.discussFileDiff,u.wh.reviewPr])&&!x(i))return;let d=`blob ${i.intent}`;i.id&&(d=`element ${t.payload.id}`),(0,r.BI)("copilot.open_copilot_chat",{source:d}),await this.sendNewMessage(e,i.content,[],i.intent,i.references??[],(0,l.Z6)(a)?a:void 0,void 0,void 0,void 0,null,void 0)}async handleSearchCopilotEvent(e){let t=await this.fetchCurrentRepo(e.repoNwo),s=t?[{type:"repository",...t}]:[];this.openChat(null,"thread","search-bar"),await this.sendNewMessage(null,e.content,[],u.wh.conversation,s),(0,r.BI)("copilot.open_copilot_chat",{source:"search-bar"})}handleAddReferenceEvent(e){this.addReference(e.reference,"event"),e.openPanel&&this.dispatch({type:"OPEN_COPILOT_CHAT",source:"event",id:e.id})}handleSymbolChangedEvent(e){let t=e.context;this.dispatch({type:"IMPLICIT_CONTEXT_UPDATED",context:[t]})}getSelectedThread(e){return e.selectedThreadID&&e.threads.get(e.selectedThreadID)||null}sortThreads(e){return Array.from(e.values()).sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime())}async sendMessageToNewThread(e,t,s,a){if(""===t.trim()){let[e,a]=this.tryInferMessage(s);if(!e||!a)return;t=a}e&&(m.J.setSavedMessageFast(e,null),m.J.clearCurrentReferences(e)),await this.sendNewMessage(null,t,[],u.wh.conversation,s,void 0,a)}startThreadReload(){this.reloadingThreadPromise=new Promise(e=>{this.resolvePromise=e})}cancelThreadReload(){this.resolvePromise(!1),this.resolvePromise=()=>{},this.reloadingThreadPromise=void 0,this.afterThreadReloadCallback=void 0,this.fetchingThreadID=null}async fetchMessages(e,t=!1,s=!1){let a=m.J.getCurrentReferences(e);if(!e)return this.threadDataLoaded(e,[],a||[],null),()=>{};t||this.dispatch({type:"MESSAGES_UPDATED",state:"loading"});let i=this.getChatState().messages;this.fetchingThreadID=e;let r=async s=>{let n=await this.service.listMessages(e);if(t&&this.fetchingThreadID!==e)return!1;if(!n.ok)return this.dispatch({type:"MESSAGES_UPDATED",state:"error",...404===n.status?{notFound:!0,missingOrgIds:n.payload?.missingOrgIds}:{}}),this.afterThreadReloadCallback=void 0,!1;if(s&&n.payload.messages.length===i.length)return r(!1);{let t=n.payload.thread;return this.threadDataLoaded(e,n.payload.messages,a||t.currentReferences||[],t.customCopilotID),this.afterThreadReloadCallback&&(this.afterThreadReloadCallback(n.payload.messages),this.afterThreadReloadCallback=void 0),!0}},n=await r(s);return()=>{this.resolvePromise(n),this.resolvePromise=()=>{},this.reloadingThreadPromise=void 0}}async fetchSharedThreadMessages(e){if(!e)return;this.dispatch({type:"MESSAGES_UPDATED",state:"loading"});let t=await this.service.listSharedThreadMessages(e);t.ok?this.threadDataLoaded(e,t.payload.messages,[]):this.dispatch({type:"MESSAGES_UPDATED",state:"error"})}selectReference(e){this.dispatch({type:"SELECT_REFERENCE",reference:e})}setTopRepositoryTopics(e){this.dispatch({type:"SET_TOP_REPOSITORIES",topics:e})}async handleStreamingMessage(e,t){try{for await(let s of t.stream())await this.processStreamingMessage(e,s)}catch(s){let t=this.isWrappedStreamingResponseError(s)?this.getStreamingErrorMessage(s.error):G(l.DW);this.handleSendMessageError(e,t);return}}isWrappedStreamingResponseError(e){return!!e&&"object"==typeof e&&"error"in e&&!!e.error&&"object"==typeof e.error&&"errorType"in e.error&&"string"==typeof e.error.errorType&&u.C6.includes(e.error.errorType)}async processStreamingMessage(e,t){var s,a,i;switch((s=this.timings).firstByte??(s.firstByte=Date.now()),t.type){case"content":(a=this.timings).firstToken??(a.firstToken=Date.now()),this.dispatch({type:"MESSAGE_STREAMING_TOKEN_ADDED",token:t.body});break;case"functionCall":i=t.name,u.xP.includes(i)&&this.dispatch({type:"MESSAGE_STREAMING_FUNCTION_CALLED",name:t.name,status:t.status,arguments:t.arguments,errorMessage:t.errorMessage,references:t.references});break;case"clientSkillsRequest":if(p.W.dotcomChatClientSideSkills){let e=this.getChatState(),s=this.getSelectedThread(e);this.skillExecutor=new SkillExecutor(s,t.toolCalls,e=>void this.sendChatMessage(e),e,this.dispatch),this.dispatch({type:"CLIENT_SKILLS_REQUEST",toolCalls:t.toolCalls})}break;case"confirmation":this.dispatch({type:"MESSAGE_STREAMING_CONFIRMATION",title:t.title,message:t.message,confirmation:t.confirmation});break;case"complete":this.dispatch({type:"MESSAGE_STREAMING_COMPLETED",messageResponse:t,timings:this.completeTiming()}),await this.handleSendMessageSuccess(e),p.W.dotcomChatClientSideSkills&&(this.skillExecutor?.setParentMessageId(t.id),await this.skillExecutor?.run());break;case"error":{let s=this.getStreamingErrorMessage(t);this.handleSendMessageError(e,s);break}case"debug":console.log("Prompt Body:",t.body);break;case"agentError":this.dispatch({type:"AGENT_ERROR",error:{type:t.agentErrorType,code:t.code,message:t.message,identifier:t.identifier}})}}getStreamingErrorMessage(e){switch(e.errorType){case"publicCode":{let e="https://docs.github.com/en/copilot/managing-copilot/managing-copilot-as-an-individual-subscriber/managing-copilot-policies-as-an-individual-subscriber",t=(0,i.jsxs)(i.Fragment,{children:["This response cannot be shown because it references public code, which is restricted by"," ",(0,i.jsx)("a",{href:e,children:"your Copilot settings"}),"."]});return this.hasCEorCBAccess&&(e="https://docs.github.com/en/enterprise-cloud@latest/copilot/managing-copilot/managing-github-copilot-in-your-organization/managing-policies-for-copilot-in-your-organization",t=(0,i.jsxs)(i.Fragment,{children:["This response cannot be shown because it references public code, which is restricted by"," ",(0,i.jsx)("a",{href:e,children:"your organization's Copilot settings"}),"."]})),{type:"publicCode",isError:!0,message:t,retryable:!1}}case"filtered":return U(l.Sr[403]||l.DW,"filtered");case"contentTooLarge":return U(l.Sr[413]||l.DW);case"rateLimit":return G(l.Sr[429]||l.DW);case"agentUnauthorized":{let t=JSON.parse(e.description);return{type:"agentUnauthorized",isError:!0,message:`You haven't authorized ${t.name} to access your account. You can do that by going here: ${window.location.origin}/login/oauth/authorize?client_id=${t.client_id}`,details:t}}case"agentRequest":{let t=JSON.parse(e.description);return{type:"agentRequest",isError:!0,message:t.message,details:t}}case"multipleAgentsAttempt":return G("Only one agent is allowed per thread, and their context can't be shared. If you want to interact with another agent, please start a new thread and @ mention the new agent.");case"networkError":return G(l.Sr[408]||l.DW);default:return G(l.DW)}}async handleSendMessageSuccess(e){m.J.setSavedMessageFast(e.id,null),m.J.clearCurrentReferences(e.id),this.dispatch({type:"WAITING_ON_COPILOT",loading:!1}),e=await this.generateThreadName(e),this.dispatch({type:"THREAD_UPDATED",thread:{...e,updatedAt:new Date().toISOString()}})}handleSendMessageError(e,t,s){e&&s&&m.J.setSavedUserMessageOnError(e.id,s);let a=h.B(this.getChatState().messages).findLast(e=>"user"===e.role)?.id||"root",i=(0,l.Y6)({role:"assistant",content:"",mediaContent:[],error:t,thread:e,parentMessageID:a});this.dispatch({type:"MESSAGE_ADDED",message:i}),this.dispatch({type:"WAITING_ON_COPILOT",loading:!1}),this.dispatch({type:"MESSAGE_STREAMING_FAILED",timings:this.completeTiming()})}async fetchModels(){if(N){let{availableModels:e}=this.getChatState();(!e||N.length>e.length)&&this.dispatch({type:"MODELS_LOADED",models:N});return}this.dispatch({type:"MODELS_LOADING"});let e=await this.service.listModels();if(e.ok){let t=(0,g.eW)(e.payload);N=t,this.dispatch({type:"MODELS_LOADED",models:t});let s=m.J.getModel(this.getChatState().selectedThreadID)?.id,a=t.find(e=>e.id===s);a&&this.dispatch({type:"SELECT_MODEL",model:a})}else this.dispatch({type:"MODELS_LOADING_ERROR",error:e.error})}async acceptModelPolicy(e){e.policy&&"enabled"!==e.policy.state&&(await this.service.setModelPolicyState(e.id,"enabled"),N=null,this.fetchModels())}async fetchThreads(){this.dispatch({type:"THREADS_LOADING"});let e=await this.service.fetchThreads();return e.ok?(setTimeout(()=>this.dispatch({type:"THREADS_LOADED",threads:e.payload}),100),e.payload):(setTimeout(()=>this.dispatch({type:"THREADS_LOADING_ERROR",message:e.error}),100),null)}async fetchLatestThread(e){let t=await this.service.fetchLatestThread(e);return t.ok?(t.payload&&this.dispatch({type:"LATEST_THREAD_LOADED",latestThread:t.payload}),t.payload):null}async continueSharedThread(e){this.dispatch({type:"MESSAGES_UPDATED",state:"loading"});let t=await this.service.continueSharedThread(e);if(!t.ok)return null;{let{thread:e,messages:s}=t.payload;this.dispatch({type:"THREAD_CONTINUED",thread:e}),this.dispatch({type:"MESSAGES_UPDATED",state:"loaded",messages:s})}return t.payload}async findOrStartNewThread(e,t){let s=null;if(e)s=e;else{let e=m.J.selectedThreadID||void 0;s=await this.fetchLatestThread(e)}if(s&&(0,l.F2)(s)&&(s=null),s&&t){let e=await this.service.listMessages(s.id);if(e.ok){let a=e.payload.messages,i=a?.length;i>=2&&!a[i-2]?.references?.find(e=>l.x_(e,t))&&(s=null)}}let a=s?.customCopilotID||null;return await this.selectThread(s,{includeThreads:!1,customCopilotId:a}),s}async generateThreadName(e){if(e.name)return e;let t=await this.service.generateThreadName(e.id);return t.ok&&(e={...e,name:t.payload}),e}async systemPrompt(e){let t=await this.service.getSystemPrompt(e);return t.ok?t.payload.prompt:""}async fetchAgents(e){let t=await this.service.listAgents(e),s=[];return t.ok&&(s=t.payload,this.dispatch({type:"SET_AGENTS",agents:s})),s}async fetchCustomCopilots(){if(!p.W.customCopilots)return[];let e=await this.service.listCustomCopilots(),t=[];return e.ok&&(t=e.payload,this.dispatch({type:"SET_CUSTOM_COPILOTS",customCopilots:t})),t}async fetchCustomCopilot(e){if(!p.W.customCopilots)return{};let t=await this.service.fetchCustomCopilot(e),s={};return t.ok&&(s=t.payload),s}async addCustomCopilot(e){let t=await this.service.listCustomCopilots(),s=[];return t.ok&&(s=t.payload,this.dispatch({type:"SET_CUSTOM_COPILOTS",customCopilots:[...s,e]})),s}async fetchCurrentRepo(e){if(p.W.topicsAsReferences){let t=await this.service.fetchRepo(e);return t.ok?(this.dispatch({type:"ADD_REFERENCE",reference:(0,l.qS)(t.payload),source:"currentRepo"}),t.payload):void 0}this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"loading"});let t=await this.service.fetchRepo(e);if(t.ok)return this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:t.payload,state:"loaded"}),t.payload;this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"error"})}async fetchKnowledgeBases(){this.dispatch({type:"KNOWLEDGE_BASES_LOADING"});let e=await this.service.listDocsets();return e.ok?this.dispatch({type:"KNOWLEDGE_BASES_LOADED",knowledgeBases:e.payload}):this.dispatch({type:"KNOWLEDGE_BASES_LOADING_ERROR",message:e.error}),e}async fetchImplicitContext(e,t,s){let a=await this.service.fetchImplicitContext(e,t,s);if(a.ok){let e=a.payload?Array.isArray(a.payload)?a.payload:[a.payload]:void 0;this.dispatch({type:"IMPLICIT_CONTEXT_UPDATED",context:e})}}async deleteDocset(e){return(await this.service.deleteDocset(e)).ok}threadDataLoaded(e,t,s,a){let{activePlugin:i}=this.getChatState();if(void 0!==a&&this.dispatch({type:"SET_CUSTOM_COPILOT_ID",customCopilotId:a}),e){let a=this.plugins.find(a=>a.matchThread?.(e,t,s));a?.id!==i&&this.dispatch({type:"SELECT_PLUGIN",plugin:a?.id})}this.dispatch({type:"MESSAGES_UPDATED",messages:t,state:"loaded"}),this.dispatch({type:"REFERENCES_LOADED",references:s})}dismissEditorUpsellBanner(){let e=new FormData;e.set("copilot_editor_upsell_banner_dismissed","true"),(0,n.DI)("/github-copilot/preferences",{method:"PUT",body:e}),this.dispatch({type:"DISMISS_EDITOR_UPSELL_BANNER"})}tryInferMessage(e){return e&&e.find(e=>"image"===e.type)?[!0,"Describe this image"]:[!1,void 0]}completeTiming(){return{...this.timings,endTime:Date.now()}}constructor(e,t,s,a,i,r,n,o){M(this,"dispatch",void 0),M(this,"service",void 0),M(this,"getChatState",void 0),M(this,"hasCEorCBAccess",void 0),M(this,"timings",{startTime:0}),M(this,"skillExecutor",void 0),M(this,"streamer",void 0),M(this,"messageAbortController",void 0),M(this,"reloadingThreadPromise",void 0),M(this,"fetchingThreadID",null),M(this,"afterThreadReloadCallback",void 0),M(this,"plugins",void 0),M(this,"clearCurrentReferences",e=>{this.dispatch({type:"CLEAR_CURRENT_REFERENCES",shouldNotClear:e})}),M(this,"resolvePromise",()=>{}),M(this,"clearCurrentTopic",()=>{this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"loaded"})}),M(this,"showTopicPicker",(e=!0)=>{this.dispatch({type:"SHOW_TOPIC_PICKER",show:e})}),this.dispatch=e,this.service=r??new d.k(t,s,i),this.getChatState=a,this.hasCEorCBAccess=!!n,this.plugins=o}};function x(e){var t;return B(e,[u.wh.explain,u.wh.suggest])||B(e,[u.wh.conversation])&&"content"in(t=e)&&"string"==typeof t.content}function B(e,t){return new Set(t).has(e.intent)}function G(e){return{isError:!0,message:e,type:"basic",retryable:!0}}function U(e,t){return{isError:!0,message:e,type:t||"basic",retryable:!1}}function H(e,t){let s=document.getElementById(e);s?.setAttribute("aria-expanded",t?"true":"false")}try{(a=Intent).displayName||(a.displayName="Intent")}catch{}},59937:(e,t,s)=>{s.d(t,{T:()=>BlobService});var a=s(56244),i=s(82610),r=s(57572),n=s(70586);let BlobService=class BlobService{async fetchBlob(e,t,s,a,o){try{let l=(0,n.WN)({commitOid:o,owner:t,path:e,pullNumber:s,repo:a}),c=await (0,r.Sr)(l,{method:"GET"});if(c.ok){let e=await c.json();return{status:c.status,ok:!0,payload:e}}return{status:c.status,ok:!1,error:i.DW}}catch{return{status:500,ok:!1,error:i.DW}}}async getBlob(e,t,s,a,i){return this.blobCache.get(e,t,s,a,i)}constructor(){!function(e,t,s){t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}(this,"blobCache",new a.d(this.fetchBlob))}}},42261:(e,t,s)=>{s.d(t,{kk:()=>i,mL:()=>o,qm:()=>n,sT:()=>a,t:()=>r});let a="open_panel",i="pull_request_review_comment_id",r="initial_path";function n(e){let t=new URL(window.location.href,window.location.origin);t.searchParams.delete(e),window.history.pushState(null,"",t.toString())}function o(e,t,s){let a=new URL(window.location.href,window.location.origin);a.searchParams.set(e,t),s?s(a.searchParams):window.history.pushState(null,"",a.toString())}},70586:(e,t,s)=>{s.d(t,{KD:()=>h,PW:()=>d,WN:()=>u,Wd:()=>r,ic:()=>g,iw:()=>c,sy:()=>m,tH:()=>l,uY:()=>p});var a=s(5796),i=s(42261);let r="edit";function n({owner:e,repo:t,pullNumber:s}){return`/${encodeURIComponent(e)}/${encodeURIComponent(t)}/pull/${s}`}function o({owner:e,repo:t,pullNumber:s}){return`${n({owner:e,repo:t,pullNumber:s})}/${r}`}function l({owner:e,repo:t,pullNumber:s,location:a}){return o({owner:e,repo:t,pullNumber:s})+(a?.search||"")}function c({owner:e,repo:t,pullNumber:s,path:i,location:r}){return`${o({owner:e,repo:t,pullNumber:s})}/file/${(0,a.QU3)(i)}`+(r?.search||"")}function d({owner:e,repo:t,pullNumber:s}){return`${n({owner:e,repo:t,pullNumber:s})}/workspace_editor/suggestions`}function h({owner:e,repo:t,pullNumber:s,pullRequestReviewCommentId:a}){return`${n({owner:e,repo:t,pullNumber:s})}/workspace_editor/suggestions/${a}`}function u({commitOid:e,owner:t,repo:s,pullNumber:a,path:i,location:r}){return`${n({owner:t,repo:s,pullNumber:a})}/workspace_editor/files/${encodeURIComponent(e)}/${encodeURIComponent(i)}`+(r?.search||"")}function p({owner:e,repo:t,pullNumber:s,location:a,path:r}){let n=`${o({owner:e,repo:t,pullNumber:s})}/new`,l=new URLSearchParams(a?.search||"");if(r&&r.includes("/")){let e=r.substring(0,r.lastIndexOf("/")+1);l.set(i.t,e)}return n+(l.toString()?`?${l.toString()}`:"")}function m({owner:e,repo:t,pullNumber:s}){return`${o({owner:e,repo:t,pullNumber:s})}/commit_changes`}function g({owner:e,repo:t,pullNumber:s,analyzeDiffs:a=!1,detectRisk:i=!1}){let r=`${n({owner:e,repo:t,pullNumber:s})}/diff`,o=new URLSearchParams({analyze_diffs:a.toString(),detect_risk:i.toString()});return`${r}?${o.toString()}`}}}]);
//# sourceMappingURL=ui_packages_copilot-chat_utils_CopilotChatContext_tsx-38228104fff6.js.map